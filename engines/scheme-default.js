(function(){var x=this;var u=x._;var c={};var k=Array.prototype,E=Object.prototype,G=Function.prototype;var v=k.slice,z=k.unshift,y=E.toString,r=E.hasOwnProperty;var p=k.forEach,j=k.map,C=k.reduce,f=k.reduceRight,o=k.filter,a=k.every,B=k.some,w=k.indexOf,g=k.lastIndexOf,d=Array.isArray,D=Object.keys,l=G.bind;var F=function(H){return new h(H)};if(typeof module!=="undefined"&&module.exports){module.exports=F;F._=F}else{x._=F}F.VERSION="1.1.7";var e=F.each=F.forEach=function(M,L,K){if(M==null){return}if(p&&M.forEach===p){M.forEach(L,K)}else{if(M.length===+M.length){for(var J=0,H=M.length;J<H;J++){if(J in M&&L.call(K,M[J],J,M)===c){return}}}else{for(var I in M){if(r.call(M,I)){if(L.call(K,M[I],I,M)===c){return}}}}}};F.map=function(K,J,I){var H=[];if(K==null){return H}if(j&&K.map===j){return K.map(J,I)}e(K,function(N,L,M){H[H.length]=J.call(I,N,L,M)});return H};F.reduce=F.foldl=F.inject=function(L,K,H,J){var I=H!==void 0;if(L==null){L=[]}if(C&&L.reduce===C){if(J){K=F.bind(K,J)}return I?L.reduce(K,H):L.reduce(K)}e(L,function(O,M,N){if(!I){H=O;I=true}else{H=K.call(J,H,O,M,N)}});if(!I){throw new TypeError("Reduce of empty array with no initial value")}return H};F.reduceRight=F.foldr=function(K,J,H,I){if(K==null){K=[]}if(f&&K.reduceRight===f){if(I){J=F.bind(J,I)}return H!==void 0?K.reduceRight(J,H):K.reduceRight(J)}var L=(F.isArray(K)?K.slice():F.toArray(K)).reverse();return F.reduce(L,J,H,I)};F.find=F.detect=function(K,J,I){var H;s(K,function(N,L,M){if(J.call(I,N,L,M)){H=N;return true}});return H};F.filter=F.select=function(K,J,I){var H=[];if(K==null){return H}if(o&&K.filter===o){return K.filter(J,I)}e(K,function(N,L,M){if(J.call(I,N,L,M)){H[H.length]=N}});return H};F.reject=function(K,J,I){var H=[];if(K==null){return H}e(K,function(N,L,M){if(!J.call(I,N,L,M)){H[H.length]=N}});return H};F.every=F.all=function(K,J,I){var H=true;if(K==null){return H}if(a&&K.every===a){return K.every(J,I)}e(K,function(N,L,M){if(!(H=H&&J.call(I,N,L,M))){return c}});return H};var s=F.some=F.any=function(K,J,I){J=J||F.identity;var H=false;if(K==null){return H}if(B&&K.some===B){return K.some(J,I)}e(K,function(N,L,M){if(H|=J.call(I,N,L,M)){return c}});return !!H};F.include=F.contains=function(J,I){var H=false;if(J==null){return H}if(w&&J.indexOf===w){return J.indexOf(I)!=-1}s(J,function(K){if(H=K===I){return true}});return H};F.invoke=function(I,J){var H=v.call(arguments,2);return F.map(I,function(K){return(J.call?J||K:K[J]).apply(K,H)})};F.pluck=function(I,H){return F.map(I,function(J){return J[H]})};F.max=function(K,J,I){if(!J&&F.isArray(K)){return Math.max.apply(Math,K)}var H={computed:-Infinity};e(K,function(O,L,N){var M=J?J.call(I,O,L,N):O;M>=H.computed&&(H={value:O,computed:M})});return H.value};F.min=function(K,J,I){if(!J&&F.isArray(K)){return Math.min.apply(Math,K)}var H={computed:Infinity};e(K,function(O,L,N){var M=J?J.call(I,O,L,N):O;M<H.computed&&(H={value:O,computed:M})});return H.value};F.sortBy=function(J,I,H){return F.pluck(F.map(J,function(M,K,L){return{value:M,criteria:I.call(H,M,K,L)}}).sort(function(N,M){var L=N.criteria,K=M.criteria;return L<K?-1:L>K?1:0}),"value")};F.groupBy=function(J,I){var H={};e(J,function(M,K){var L=I(M,K);(H[L]||(H[L]=[])).push(M)});return H};F.sortedIndex=function(M,L,J){J||(J=F.identity);var H=0,K=M.length;while(H<K){var I=(H+K)>>1;J(M[I])<J(L)?H=I+1:K=I}return H};F.toArray=function(H){if(!H){return[]}if(H.toArray){return H.toArray()}if(F.isArray(H)){return v.call(H)}if(F.isArguments(H)){return v.call(H)}return F.values(H)};F.size=function(H){return F.toArray(H).length};F.first=F.head=function(J,I,H){return(I!=null)&&!H?v.call(J,0,I):J[0]};F.rest=F.tail=function(J,H,I){return v.call(J,(H==null)||I?1:H)};F.last=function(H){return H[H.length-1]};F.compact=function(H){return F.filter(H,function(I){return !!I})};F.flatten=function(H){return F.reduce(H,function(I,J){if(F.isArray(J)){return I.concat(F.flatten(J))}I[I.length]=J;return I},[])};F.without=function(H){return F.difference(H,v.call(arguments,1))};F.uniq=F.unique=function(I,H){return F.reduce(I,function(J,L,K){if(0==K||(H===true?F.last(J)!=L:!F.include(J,L))){J[J.length]=L}return J},[])};F.union=function(){return F.uniq(F.flatten(arguments))};F.intersection=F.intersect=function(I){var H=v.call(arguments,1);return F.filter(F.uniq(I),function(J){return F.every(H,function(K){return F.indexOf(K,J)>=0})})};F.difference=function(I,H){return F.filter(I,function(J){return !F.include(H,J)})};F.zip=function(){var H=v.call(arguments);var K=F.max(F.pluck(H,"length"));var J=new Array(K);for(var I=0;I<K;I++){J[I]=F.pluck(H,""+I)}return J};F.indexOf=function(L,J,K){if(L==null){return -1}var I,H;if(K){I=F.sortedIndex(L,J);return L[I]===J?I:-1}if(w&&L.indexOf===w){return L.indexOf(J)}for(I=0,H=L.length;I<H;I++){if(L[I]===J){return I}}return -1};F.lastIndexOf=function(J,I){if(J==null){return -1}if(g&&J.lastIndexOf===g){return J.lastIndexOf(I)}var H=J.length;while(H--){if(J[H]===I){return H}}return -1};F.range=function(M,K,L){if(arguments.length<=1){K=M||0;M=0}L=arguments[2]||1;var I=Math.max(Math.ceil((K-M)/L),0);var H=0;var J=new Array(I);while(H<I){J[H++]=M;M+=L}return J};F.bind=function(I,J){if(I.bind===l&&l){return l.apply(I,v.call(arguments,1))}var H=v.call(arguments,2);return function(){return I.apply(J,H.concat(v.call(arguments)))}};F.bindAll=function(I){var H=v.call(arguments,1);if(H.length==0){H=F.functions(I)}e(H,function(J){I[J]=F.bind(I[J],I)});return I};F.memoize=function(J,I){var H={};I||(I=F.identity);return function(){var K=I.apply(this,arguments);return r.call(H,K)?H[K]:(H[K]=J.apply(this,arguments))}};F.delay=function(I,J){var H=v.call(arguments,2);return setTimeout(function(){return I.apply(I,H)},J)};F.defer=function(H){return F.delay.apply(F,[H,1].concat(v.call(arguments,1)))};var A=function(I,K,H){var J;return function(){var M=this,L=arguments;var N=function(){J=null;I.apply(M,L)};if(H){clearTimeout(J)}if(H||!J){J=setTimeout(N,K)}}};F.throttle=function(H,I){return A(H,I,false)};F.debounce=function(H,I){return A(H,I,true)};F.once=function(J){var H=false,I;return function(){if(H){return I}H=true;return I=J.apply(this,arguments)}};F.wrap=function(H,I){return function(){var J=[H].concat(v.call(arguments));return I.apply(this,J)}};F.compose=function(){var H=v.call(arguments);return function(){var I=v.call(arguments);for(var J=H.length-1;J>=0;J--){I=[H[J].apply(this,I)]}return I[0]}};F.after=function(I,H){return function(){if(--I<1){return H.apply(this,arguments)}}};F.keys=D||function(J){if(J!==Object(J)){throw new TypeError("Invalid object")}var I=[];for(var H in J){if(r.call(J,H)){I[I.length]=H}}return I};F.values=function(H){return F.map(H,F.identity)};F.functions=F.methods=function(J){var I=[];for(var H in J){if(F.isFunction(J[H])){I.push(H)}}return I.sort()};F.extend=function(H){e(v.call(arguments,1),function(I){for(var J in I){if(I[J]!==void 0){H[J]=I[J]}}});return H};F.defaults=function(H){e(v.call(arguments,1),function(I){for(var J in I){if(H[J]==null){H[J]=I[J]}}});return H};F.clone=function(H){return F.isArray(H)?H.slice():F.extend({},H)};F.tap=function(I,H){H(I);return I};F.isEqual=function(I,H){if(I===H){return true}var L=typeof(I),N=typeof(H);if(L!=N){return false}if(I==H){return true}if((!I&&H)||(I&&!H)){return false}if(I._chain){I=I._wrapped}if(H._chain){H=H._wrapped}if(I.isEqual){return I.isEqual(H)}if(H.isEqual){return H.isEqual(I)}if(F.isDate(I)&&F.isDate(H)){return I.getTime()===H.getTime()}if(F.isNaN(I)&&F.isNaN(H)){return false}if(F.isRegExp(I)&&F.isRegExp(H)){return I.source===H.source&&I.global===H.global&&I.ignoreCase===H.ignoreCase&&I.multiline===H.multiline}if(L!=="object"){return false}if(I.length&&(I.length!==H.length)){return false}var J=F.keys(I),M=F.keys(H);if(J.length!=M.length){return false}for(var K in I){if(!(K in H)||!F.isEqual(I[K],H[K])){return false}}return true};F.isEmpty=function(I){if(F.isArray(I)||F.isString(I)){return I.length===0}for(var H in I){if(r.call(I,H)){return false}}return true};F.isElement=function(H){return !!(H&&H.nodeType==1)};F.isArray=d||function(H){return y.call(H)==="[object Array]"};F.isObject=function(H){return H===Object(H)};F.isArguments=function(H){return !!(H&&r.call(H,"callee"))};F.isFunction=function(H){return !!(H&&H.constructor&&H.call&&H.apply)};F.isString=function(H){return !!(H===""||(H&&H.charCodeAt&&H.substr))};F.isNumber=function(H){return !!(H===0||(H&&H.toExponential&&H.toFixed))};F.isNaN=function(H){return H!==H};F.isBoolean=function(H){return H===true||H===false};F.isDate=function(H){return !!(H&&H.getTimezoneOffset&&H.setUTCFullYear)};F.isRegExp=function(H){return !!(H&&H.test&&H.exec&&(H.ignoreCase||H.ignoreCase===false))};F.isNull=function(H){return H===null};F.isUndefined=function(H){return H===void 0};F.noConflict=function(){x._=u;return this};F.identity=function(H){return H};F.times=function(K,J,I){for(var H=0;H<K;H++){J.call(I,H)}};F.mixin=function(H){e(F.functions(H),function(I){t(I,F[I]=H[I])})};var m=0;F.uniqueId=function(H){var I=m++;return H?H+I:I};F.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g};F.template=function(K,J){var L=F.templateSettings;var H="var __p=[],print=function(){__p.push.apply(__p,arguments);};with(obj||{}){__p.push('"+K.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(L.interpolate,function(M,N){return"',"+N.replace(/\\'/g,"'")+",'"}).replace(L.evaluate||null,function(M,N){return"');"+N.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');";var I=new Function("obj",H);return J?I(J):I};var h=function(H){this._wrapped=H};F.prototype=h.prototype;var q=function(I,H){return H?F(I).chain():I};var t=function(H,I){h.prototype[H]=function(){var J=v.call(arguments);z.call(J,this._wrapped);return q(I.apply(F,J),this._chain)}};F.mixin(F);e(["pop","push","reverse","shift","sort","splice","unshift"],function(H){var I=k[H];h.prototype[H]=function(){I.apply(this._wrapped,arguments);return q(this._wrapped,this._chain)}});e(["concat","join","slice"],function(H){var I=k[H];h.prototype[H]=function(){return q(I.apply(this._wrapped,arguments),this._chain)}});h.prototype.chain=function(){this._chain=true;return this};h.prototype.value=function(){return this._wrapped}})();(function(){var a=this;var e=String.prototype.trim;var d=function(h){return h*1||0};function f(j,h){for(var k=[];h>0;k[--h]=j){}return k.join("")}function c(h){if(h){return g.escapeRegExp(h)}return"\\s"}var g={isBlank:function(h){return !!h.match(/^\s*$/)},capitalize:function(h){return h.charAt(0).toUpperCase()+h.substring(1).toLowerCase()},chop:function(l,k){k=k||l.length;var h=[];for(var j=0;j<l.length;){h.push(l.slice(j,j+k));j=j+k}return h},clean:function(h){return g.strip(h.replace(/\s+/g," "))},count:function(m,l){var k=0,h;for(var j=0;j<m.length;){h=m.indexOf(l,j);h>=0&&k++;j=j+(h>=0?h:0)+l.length}return k},chars:function(h){return h.split("")},escapeHTML:function(h){return String(h||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")},unescapeHTML:function(h){return String(h||"").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&apos;/g,"'")},escapeRegExp:function(h){return String(h||"").replace(/([-.*+?^${}()|[\]\/\\])/g,"\\$1")},insert:function(l,j,k){var h=l.split("");h.splice(j,0,k);return h.join("")},includes:function(j,h){return j.indexOf(h)!==-1},join:function(h){h=String(h);var k="";for(var j=1;j<arguments.length;j+=1){k+=String(arguments[j]);if(j!==arguments.length-1){k+=h}}return k},lines:function(h){return h.split("\n")},splice:function(m,j,l,k){var h=m.split("");h.splice(j,l,k);return h.join("")},startsWith:function(j,h){return j.length>=h.length&&j.substring(0,h.length)===h},endsWith:function(j,h){return j.length>=h.length&&j.substring(j.length-h.length)===h},succ:function(j){var h=j.split("");h.splice(j.length-1,1,String.fromCharCode(j.charCodeAt(j.length-1)+1));return h.join("")},titleize:function(l){var h=l.split(" "),k;for(var j=0;j<h.length;j++){k=h[j].split("");if(typeof k[0]!=="undefined"){k[0]=k[0].toUpperCase()}j+1===h.length?h[j]=k.join(""):h[j]=k.join("")+" "}return h.join("")},camelize:function(h){return g.trim(h).replace(/(\-|_|\s)+(.)?/g,function(j,l,k){return k?k.toUpperCase():""})},underscored:function(h){return g.trim(h).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/\-|\s+/g,"_").toLowerCase()},dasherize:function(h){return g.trim(h).replace(/([a-z\d])([A-Z]+)/g,"$1-$2").replace(/^([A-Z]+)/,"-$1").replace(/\_|\s+/g,"-").toLowerCase()},trim:function(j,h){if(!h&&e){return e.call(j)}h=c(h);return j.replace(new RegExp("^["+h+"]+|["+h+"]+$","g"),"")},ltrim:function(j,h){h=c(h);return j.replace(new RegExp("^["+h+"]+","g"),"")},rtrim:function(j,h){h=c(h);return j.replace(new RegExp("["+h+"]+$","g"),"")},truncate:function(k,j,h){h=h||"...";return k.slice(0,j)+h},words:function(j,h){h=h||" ";return j.split(h)},pad:function(o,k,h,j){var m="";var l=0;if(!h){h=" "}else{if(h.length>1){h=h[0]}}switch(j){case"right":l=(k-o.length);m=f(h,l);o=o+m;break;case"both":l=(k-o.length);m={left:f(h,Math.ceil(l/2)),right:f(h,Math.floor(l/2))};o=m.left+o+m.right;break;default:l=(k-o.length);m=f(h,l);o=m+o}return o},lpad:function(k,j,h){return g.pad(k,j,h)},rpad:function(k,j,h){return g.pad(k,j,h,"right")},lrpad:function(k,j,h){return g.pad(k,j,h,"both")},sprintf:function(){var l=0,t,q=arguments[l++],j=[],k,h,r,u,v="";while(q){if(k=/^[^\x25]+/.exec(q)){j.push(k[0])}else{if(k=/^\x25{2}/.exec(q)){j.push("%")}else{if(k=/^\x25(?:(\d+)\$)?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(q)){if(((t=arguments[k[1]||l++])==null)||(t==undefined)){throw ("Too few arguments.")}if(/[^s]/.test(k[7])&&(typeof(t)!="number")){throw ("Expecting number but found "+typeof(t))}switch(k[7]){case"b":t=t.toString(2);break;case"c":t=String.fromCharCode(t);break;case"d":t=parseInt(t);break;case"e":t=k[6]?t.toExponential(k[6]):t.toExponential();break;case"f":t=k[6]?parseFloat(t).toFixed(k[6]):parseFloat(t);break;case"o":t=t.toString(8);break;case"s":t=((t=String(t))&&k[6]?t.substring(0,k[6]):t);break;case"u":t=Math.abs(t);break;case"x":t=t.toString(16);break;case"X":t=t.toString(16).toUpperCase();break}t=(/[def]/.test(k[7])&&k[2]&&t>=0?"+"+t:t);r=k[3]?k[3]=="0"?"0":k[3].charAt(1):" ";u=k[5]-String(t).length-v.length;h=k[5]?f(r,u):"";j.push(v+(k[4]?t+h:h+t))}else{throw ("Huh ?!")}}}q=q.substring(k[0].length)}return j.join("")},toNumber:function(j,h){return d(d(j).toFixed(d(h)))},strRight:function(k,h){var j=(!h)?-1:k.indexOf(h);return(j!=-1)?k.slice(j+h.length,k.length):k},strRightBack:function(k,h){var j=(!h)?-1:k.lastIndexOf(h);return(j!=-1)?k.slice(j+h.length,k.length):k},strLeft:function(k,h){var j=(!h)?-1:k.indexOf(h);return(j!=-1)?k.slice(0,j):k},strLeftBack:function(k,h){var j=k.lastIndexOf(h);return(j!=-1)?k.slice(0,j):k}};g.strip=g.trim;g.lstrip=g.ltrim;g.rstrip=g.rtrim;g.center=g.lrpad;g.ljust=g.lpad;g.rjust=g.rpad;if(typeof window==="undefined"&&typeof module!=="undefined"){module.exports=g}else{if(typeof a._!=="undefined"){a._.mixin(g)}else{a._=g}}}());var BiwaScheme=BiwaScheme||{};BiwaScheme.Class={create:function(c){var a=function(){this.initialize.apply(this,arguments)};_.extend(a.prototype,c);return a},extend:function(d,c){var a=function(){this.initialize.apply(this,arguments)};a.prototype=d;_.extend(a.prototype,c);return a}};BiwaScheme.TopEnv={};BiwaScheme.CoreEnv={};BiwaScheme.Error=BiwaScheme.Class.create({initialize:function(a){this.message="Error: "+a},toString:function(){return this.message}});BiwaScheme.Bug=BiwaScheme.Class.extend(new BiwaScheme.Error(),{initialize:function(a){this.message="[BUG] "+a}});BiwaScheme.UserError=BiwaScheme.Class.extend(new BiwaScheme.Error(),{initialize:function(a){this.message=a}});BiwaScheme.inspect=function(a,c){try{if(_.isUndefined(a)){return"undefined"}if(a===null){return"null"}if(a===true){return"#t"}if(a===false){return"#f"}if(a.inspect){return a.inspect()}if(_.isString(a)){return"'"+a.replace(/'/g,"\\'")+"'"}if(_.isArray(a)){return"["+_.map(a,BiwaScheme.inspect).join(", ")+"]"}if(c&&c.fallback){return c.fallback}else{return a.toString()}}catch(d){if(d instanceof RangeError){return"..."}throw d}};BiwaScheme.Set=BiwaScheme.Class.create({initialize:function(){this.arr=[];var a;for(a=0;a<arguments.length;a++){this.arr[a]=arguments[a]}},equals:function(c){if(this.arr.length!=c.arr.length){return false}var d=_.clone(this.arr);var a=_.clone(c.arr);d.sort();a.sort();for(var e=0;e<this.arr.length;e++){if(d[e]!=a[e]){return false}}return true},set_cons:function(a){var c=new BiwaScheme.Set(a);c.arr=_.clone(this.arr);c.arr.push(a);return c},set_union:function(){var e=new BiwaScheme.Set();e.arr=_.clone(this.arr);for(var a=0;a<arguments.length;a++){var c=arguments[a];if(!(c instanceof BiwaScheme.Set)){throw new BiwaScheme.Error("set_union: arguments must be a set")}for(var d=0;d<c.arr.length;d++){e.add(c.arr[d])}}return e},set_intersect:function(a){if(!(a instanceof BiwaScheme.Set)){throw new BiwaScheme.Error("set_intersect: arguments must be a set")}var d=new BiwaScheme.Set();for(var c=0;c<this.arr.length;c++){if(a.member(this.arr[c])){d.add(this.arr[c])}}return d},set_minus:function(a){if(!(a instanceof BiwaScheme.Set)){throw new BiwaScheme.Error("set_minus: arguments must be a set")}var d=new BiwaScheme.Set();for(var c=0;c<this.arr.length;c++){if(!a.member(this.arr[c])){d.add(this.arr[c])}}return d},add:function(a){if(!this.member(a)){this.arr.push(a)}},member:function(c){for(var a=0;a<this.arr.length;a++){if(this.arr[a]==c){return true}}return false},rindex:function(c){for(var a=this.arr.length-1;a>=0;a--){if(this.arr[a]==c){return(this.arr.length-1-a)}}return null},index:function(c){for(var a=0;a<this.arr.length;a++){if(this.arr[a]==c){return a}}return null},inspect:function(){return"Set("+this.arr.join(", ")+")"},toString:function(){return this.inspect()},size:function(){return this.arr.length}});BiwaScheme.to_write=function(a){if(a===undefined){return"undefined"}else{if(a===null){return"null"}else{if(_.isFunction(a)){return"#<Function "+(a.fname?a.fname:a.toSource?_.truncate(a.toSource(),40):"")+">"}else{if(_.isString(a)){return'"'+a.replace(/\\|\"/g,function(c){return"\\"+c}).replace(/\x07/g,"\\a").replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\v/g,"\\v").replace(/\f/g,"\\f").replace(/\r/g,"\\r")+'"'}else{if(_.isArray(a)&&a.closure_p){return"#<Closure>"}else{if(_.isArray(a)){return"#("+_.map(a,function(c){return BiwaScheme.to_write(c)}).join(" ")+")"}else{if(typeof(a.to_write)=="function"){return a.to_write()}else{if(isNaN(a)&&typeof(a)=="number"){return"+nan.0"}else{switch(a){case true:return"#t";case false:return"#f";case Infinity:return"+inf.0";case -Infinity:return"-inf.0"}}}}}}}}}return BiwaScheme.inspect(a)};BiwaScheme.to_display=function(a){if(typeof(a.valueOf())=="string"){return a}else{if(a instanceof BiwaScheme.Symbol){return a.name}else{if(a instanceof Array){return"#("+_.map(a,BiwaScheme.to_display).join(" ")+")"}else{if(a instanceof BiwaScheme.Pair){return a.inspect(BiwaScheme.to_display)}else{if(a instanceof BiwaScheme.Char){return a.value}else{return BiwaScheme.to_write(a)}}}}}};BiwaScheme.write_ss=function(f,a){var e=[f],d=[false];BiwaScheme.find_cyclic(f,e,d);var h=BiwaScheme.reduce_cyclic_info(e,d);var g=new Array(h.length);for(var c=h.length-1;c>=0;c--){g[c]=false}return BiwaScheme.to_write_ss(f,h,g,a)};BiwaScheme.to_write_ss=function(g,k,j,c){var e="";var f=k.indexOf(g);if(f>=0){if(j[f]){return"#"+f+"#"}else{j[f]=true;e="#"+f+"="}}if(g instanceof BiwaScheme.Pair){var d=[];d.push(BiwaScheme.to_write_ss(g.car,k,j,c));for(var h=g.cdr;h!=BiwaScheme.nil;h=h.cdr){if(!(h instanceof BiwaScheme.Pair)||k.indexOf(h)>=0){d.push(".");d.push(BiwaScheme.to_write_ss(h,k,j,c));break}d.push(BiwaScheme.to_write_ss(h.car,k,j,c))}e+="("+d.join(" ")+")"}else{if(g instanceof Array){var d=_.map(g,function(a){return BiwaScheme.to_write_ss(a,k,j,c)});if(c){e+="["+d.join(", ")+"]"}else{e+="#("+d.join(" ")+")"}}else{e+=BiwaScheme.to_write(g)}}return e};BiwaScheme.reduce_cyclic_info=function(e,d){var c=0;for(var a=0;a<d.length;a++){if(d[a]){e[c]=e[a];c++}}return e.slice(0,c)};BiwaScheme.find_cyclic=function(e,d,c){var a=(e instanceof BiwaScheme.Pair)?[e.car,e.cdr]:(e instanceof Array)?e:null;if(!a){return}_.each(a,function(g){if(typeof(g)=="number"||typeof(g)=="string"||g===BiwaScheme.undef||g===true||g===false||g===BiwaScheme.nil||g instanceof BiwaScheme.Symbol){return}var f=d.indexOf(g);if(f>=0){c[f]=true}else{d.push(g);c.push(false);BiwaScheme.find_cyclic(g,d,c)}})};BiwaScheme.Pair=BiwaScheme.Class.create({initialize:function(a,c){this.car=a;this.cdr=c},caar:function(){return this.car.car},cadr:function(){return this.cdr.car},cdar:function(){return this.cdr.car},cddr:function(){return this.cdr.cdr},first:function(){return this.car},second:function(){return this.cdr.car},third:function(){return this.cdr.cdr.car},fourth:function(){return this.cdr.cdr.cdr.car},fifth:function(){return this.cdr.cdr.cdr.cdr.car},to_array:function(){var a=[];for(var c=this;c instanceof BiwaScheme.Pair;c=c.cdr){a.push(c.car)}return a},to_set:function(){var c=new BiwaScheme.Set();for(var a=this;a instanceof BiwaScheme.Pair;a=a.cdr){c.add(a.car)}return c},length:function(){var c=0;for(var a=this;a instanceof BiwaScheme.Pair;a=a.cdr){c++}return c},foreach:function(a){for(var c=this;c instanceof BiwaScheme.Pair;c=c.cdr){a(c.car)}return c},map:function(c){var a=[];for(var d=this;BiwaScheme.isPair(d);d=d.cdr){a.push(c(d.car))}return a},concat:function(a){var c=this;while(c instanceof BiwaScheme.Pair&&c.cdr!=BiwaScheme.nil){c=c.cdr}c.cdr=a;return this},inspect:function(e){e||(e=BiwaScheme.inspect);var c=[];var d=this.foreach(function(a){c.push(e(a))});if(d!=BiwaScheme.nil){c.push(".");c.push(e(d))}return"("+c.join(" ")+")"},toString:function(){return this.inspect()},to_write:function(){return this.inspect(BiwaScheme.to_write)}});var array_to_list=function(d,a){var e=BiwaScheme.nil;for(var c=d.length-1;c>=0;c--){var f=d[c];if(a&&_.isArray(f)&&!f.is_vector){f=BiwaScheme.array_to_list(f)}e=new BiwaScheme.Pair(f,e)}return e};BiwaScheme.List=function(){var a=_.toArray(arguments);return array_to_list(a,true)};BiwaScheme.array_to_list=function(a){return BiwaScheme.List.apply(null,a)};BiwaScheme.shallow_array_to_list=function(a){return array_to_list(a,false)};BiwaScheme.Values=BiwaScheme.Class.create({initialize:function(a){this.content=a},to_write:function(){return"#<Values "+_.map(this.content,BiwaScheme.to_write).join(" ")+">"}});BiwaScheme.nil={toString:function(){return"nil"},to_write:function(){return"()"},to_array:function(){return[]},length:function(){return 0}};BiwaScheme.undef=new Object();BiwaScheme.undef.toString=function(){return"#<undef>"};BiwaScheme.eof=new Object;BiwaScheme.Symbol=BiwaScheme.Class.create({initialize:function(a){this.name=a;BiwaScheme.Symbols[a]=this},inspect:function(){return"'"+this.name},toString:function(){return"'"+this.name},to_write:function(){return this.name}});BiwaScheme.Symbols={};BiwaScheme.Sym=function(a,c){if(BiwaScheme.Symbols[a]===undefined){return new BiwaScheme.Symbol(a)}else{if(!(BiwaScheme.Symbols[a] instanceof BiwaScheme.Symbol)){return new BiwaScheme.Symbol(a)}else{return BiwaScheme.Symbols[a]}}};BiwaScheme.gensyms=0;BiwaScheme.gensym=function(){BiwaScheme.gensyms++;return BiwaScheme.Sym("__gensym_"+BiwaScheme.gensyms)};BiwaScheme.Char=BiwaScheme.Class.create({initialize:function(a){BiwaScheme.Chars[this.value=a]=this},to_write:function(){switch(this.value){case"\n":return"#\\newline";case" ":return"#\\space";case"\t":return"#\\tab";default:return"#\\"+this.value}},inspect:function(){return this.to_write()}});BiwaScheme.Chars={};BiwaScheme.Char.get=function(a){if(typeof(a)!="string"){throw new BiwaScheme.Bug("Char.get: "+BiwaScheme.inspect(a)+" is not a string")}if(BiwaScheme.Chars[a]===undefined){return new BiwaScheme.Char(a)}else{return BiwaScheme.Chars[a]}};BiwaScheme.Complex=BiwaScheme.Class.create({initialize:function(c,a){this.real=c;this.imag=a},magnitude:function(){return Math.sqrt(this.real*this.real+this.imag*this.imag)},angle:function(){return Math.acos(this.real/this.magnitude())}});BiwaScheme.Complex.from_polar=function(c,a){var e=c*Math.cos(a);var d=c*Math.sin(a);return new BiwaScheme.Complex(e,d)};BiwaScheme.Complex.assure=function(a){if(a instanceof BiwaScheme.Complex){return a}else{return new BiwaScheme.Complex(a,0)}};BiwaScheme.Rational=BiwaScheme.Class.create({initialize:function(a,c){this.numerator=a;this.denominator=c}});BiwaScheme.Port=BiwaScheme.Class.create({initialize:function(a,c){this.is_open=true;this.is_binary=false;this.is_input=a;this.is_output=c},close:function(){this.is_open=false},inspect:function(){return"#<Port>"},to_write:function(){return"#<Port>"}});BiwaScheme.Port.BrowserInput=BiwaScheme.Class.extend(new BiwaScheme.Port(true,false),{initialize:function(){},get_string:function(c){var a=$("<form/>");a.html("<input id='webscheme-read-line' type='text'><input type='submit' value='ok'>");$("#bs-console").append(a);return new BiwaScheme.Pause(function(d){a.submit(function(){var e=$("#webscheme-read-line").val();a.remove();BiwaScheme.Port.current_output.put_string(e);d.resume(c(e));return false})})}});BiwaScheme.Port.DefaultOutput=BiwaScheme.Class.extend(new BiwaScheme.Port(false,true),{initialize:function(){},put_string:function(a){BiwaScheme.Port.current_output.put_string(a,true)}});BiwaScheme.Port.NullOutput=BiwaScheme.Class.extend(new BiwaScheme.Port(false,true),{initialize:function(){},put_string:function(){}});BiwaScheme.Port.NullInput=BiwaScheme.Class.extend(new BiwaScheme.Port(true,false),{initialize:function(){},get_string:function(a){return a("")}});BiwaScheme.Port.CustomOutput=BiwaScheme.Class.extend(new BiwaScheme.Port(false,true),{initialize:function(a){this.output_function=a},put_string:function(a){this.output_function(a)}});BiwaScheme.Port.CustomInput=BiwaScheme.Class.extend(new BiwaScheme.Port(true,false),{initialize:function(a){this.input_function=a},get_string:function(a){var c=this.input_function;return new BiwaScheme.Pause(function(d){c(function(e){d.resume(a(e))})})}});BiwaScheme.Port.StringOutput=BiwaScheme.Class.extend(new BiwaScheme.Port(false,true),{initialize:function(){this.buffer=[]},put_string:function(a){this.buffer.push(a)},output_string:function(a){return this.buffer.join("")}});BiwaScheme.Port.StringInput=BiwaScheme.Class.extend(new BiwaScheme.Port(true,false),{initialize:function(a){this.str=a},get_string:function(a){return a(this.str)}});BiwaScheme.Port.current_input=new BiwaScheme.Port.NullInput();BiwaScheme.Port.current_output=new BiwaScheme.Port.NullOutput();BiwaScheme.Port.current_error=new BiwaScheme.Port.NullOutput();BiwaScheme.Record=BiwaScheme.Class.create({initialize:function(c,a){assert_record_td(c,"new Record");this.rtd=c;this.fields=a},get:function(a){return this.fields[a]},set:function(c,a){this.fields[c]=a},toString:function(){var a=BiwaScheme.to_write(this.fields);return"#<Record "+this.rtd.name+" "+a+">"}});BiwaScheme.isRecord=function(a){return(a instanceof BiwaScheme.Record)};BiwaScheme.Record._DefinedTypes={};BiwaScheme.Record.define_type=function(a,c,d){return BiwaScheme.Record._DefinedTypes[a]={rtd:c,cd:d}};BiwaScheme.Record.get_type=function(a){return BiwaScheme.Record._DefinedTypes[a]};BiwaScheme.Record.RTD=BiwaScheme.Class.create({initialize:function(e,d,f,c,g,a){this.name=e;this.parent_rtd=d;this.is_base_type=!d;if(f){this.uid=f;this.generative=false}else{this.uid=this._generate_new_uid();this.generative=true}this.sealed=!!c;this.opaque=d.opaque||(!!g);this.fields=_.map(a,function(h){return{name:h[0],mutable:!!h[1]}})},field_name:function(a){var c=this._field_names();for(par=this.parent_rtd;par;par=par.parent_rtd){c=par._field_names()+c}return c[a]},_field_names:function(){return _.map(this.fields,function(a){return a.name})},_generate_new_uid:function(){var a=(BiwaScheme.Record.RTD.last_uid++);return BiwaScheme.Sym("__record_td_uid_"+a)},toString:function(){return"#<RecordTD "+name+">"}});BiwaScheme.Record.RTD.last_uid=0;BiwaScheme.Record.RTD.NongenerativeRecords={};BiwaScheme.isRecordTD=function(a){return(a instanceof BiwaScheme.Record.RTD)};BiwaScheme.Record.CD=BiwaScheme.Class.create({initialize:function(a,c,d){this._check(a,c,d);this.rtd=a;this.parent_cd=c;if(d){this.has_custom_protocol=true;this.protocol=d}else{this.has_custom_protocol=false;if(a.parent_rtd){this.protocol=this._default_protocol_for_derived_types()}else{this.protocol=this._default_protocol_for_base_types()}}},_check:function(a,c,d){if(a.is_base_type&&c){throw new Error("Record.CD.new: cannot specify parent cd of a base type")}if(c&&a.parent_rtd&&(c.rtd!=a.parent_rtd)){throw new Error("Record.CD.new: mismatched parents between rtd and parent_cd")}if(a.parent_rtd&&!c&&d){throw new Error("Record.CD.new: protocol must be #f when parent_cd is not given")}if(c&&c.has_custom_protocol&&!d){throw new Error("Record.CD.new: protocol must be specified when parent_cd has a custom protocol")}},_default_protocol_for_base_types:function(){return function(a){var c=a[0];assert_procedure(c,"_default_protocol/base");return c}},_default_protocol_for_derived_types:function(){var a=this.rtd;return function(c){var e=c[0];assert_procedure(e,"_default_protocol/n");var d=function(g){var j=a.fields.length;var k=g.length-j;var f=g.slice(0,k);var h=g.slice(k);return new BiwaScheme.Call(e,f,function(l){var m=l[0];assert_procedure(m,"_default_protocol/p");return new BiwaScheme.Call(m,h,function(p){var o=p[0];assert_record(o,"_default_protocol/result");return o})})};return d}},toString:function(){return"#<RecordCD "+this.rtd.name+">"},record_constructor:function(){var a=(this.parent_cd?this._make_n([],this.rtd):this._make_p());a=_.bind(a,this);return new BiwaScheme.Call(this.protocol,[a],function(c){var d=c[0];assert_procedure(d,"record_constructor");return d})},_make_p:function(){return function(a){return new BiwaScheme.Record(this.rtd,a)}},_make_n:function(a,c){var d=this.parent_cd;if(d){var e=function(g){var f=function(k){var j=[].concat(k[0]).concat(a);var h=d._make_n(j,c);return new BiwaScheme.Call(d.protocol,[h],function(l){var m=l[0];assert_procedure(m,"_make_n");return new BiwaScheme.Call(m,g,function(p){var o=p[0];assert_record(o);return o})})};return f};return e}else{var e=function(g){var f=g.concat(a);return new BiwaScheme.Record(c,f)};return e}}});BiwaScheme.isRecordCD=function(a){return(a instanceof BiwaScheme.Record.CD)};BiwaScheme.Enumeration={};BiwaScheme.Enumeration.EnumType=BiwaScheme.Class.create({initialize:function(a){this.members=_.uniq(a)},universe:function(){return new BiwaScheme.Enumeration.EnumSet(this,this.members)},indexer:function(){return _.bind(function(c){assert_symbol(c[0],"(enum-set indexer)");var a=_.indexOf(this.members,c[0]);return(a===-1)?false:a},this)},constructor:function(){return _.bind(function(a){assert_list(a[0],"(enum-set constructor)");var c=a[0].to_array();_.each(c,function(d){assert_symbol(d,"(enum-set constructor)")});return new BiwaScheme.Enumeration.EnumSet(this,c)},this)}});BiwaScheme.Enumeration.EnumSet=BiwaScheme.Class.create({initialize:function(c,a){this.enum_type=c;this.symbols=_.filter(c.members,function(d){return _.include(a,d)})},symbol_list:function(){return BiwaScheme.array_to_list(this.symbols)},is_member:function(a){return _.include(this.symbols,a)},is_subset:function(a){if(_.any(this.symbols,function(c){return !_.include(a.symbols,c)})){return false}if(this.enum_type===a.enum_type){return true}else{return _.all(this.enum_type.members,function(c){return _.include(a.enum_type.members,c)})}},equal_to:function(a){return this.is_subset(a)&&a.is_subset(this)},union:function(a){var c=_.filter(this.enum_type.members,_.bind(function(d){return _.include(this.symbols,d)||_.include(a.symbols,d)},this));return new BiwaScheme.Enumeration.EnumSet(this.enum_type,c)},intersection:function(a){var c=_.filter(this.symbols,function(d){return _.include(a.symbols,d)});return new BiwaScheme.Enumeration.EnumSet(this.enum_type,c)},difference:function(a){var c=_.filter(this.symbols,function(d){return !_.include(a.symbols,d)});return new BiwaScheme.Enumeration.EnumSet(this.enum_type,c)},complement:function(){var a=_.filter(this.enum_type.members,_.bind(function(c){return !_.include(this.symbols,c)},this));return new BiwaScheme.Enumeration.EnumSet(this.enum_type,a)},projection:function(a){var c=_.filter(this.symbols,function(d){return _.include(a.enum_type.members,d)});return new BiwaScheme.Enumeration.EnumSet(a.enum_type,c)},toString:function(){return"#<EnumSet "+BiwaScheme.inspect(this.symbols)+">"}});BiwaScheme.isEnumSet=function(a){return(a instanceof BiwaScheme.Enumeration.EnumSet)};BiwaScheme.Hashtable=BiwaScheme.Class.create({initialize:function(c,d,a){this.mutable=(a===undefined)?true:a?true:false;this.hash_proc=c;this.equiv_proc=d;this.pairs_of={}},clear:function(){this.pairs_of={}},candidate_pairs:function(a){return this.pairs_of[a]},add_pair:function(e,a,d){var c=this.pairs_of[e];if(c){c.push([a,d])}else{this.pairs_of[e]=[[a,d]]}},remove_pair:function(d,e){var c=this.pairs_of[d];var a=c.indexOf(e);if(a==-1){throw new BiwaScheme.Bug("Hashtable#remove_pair: pair not found!")}else{c.splice(a,1)}},create_copy:function(a){var c=new BiwaScheme.Hashtable(this.hash_proc,this.equiv_proc,a);_.each(_.keys(this.pairs_of),_.bind(function(f){var e=this.pairs_of[f];var d=_.map(e,function(g){return _.clone(g)});c.pairs_of[f]=d},this));return c},size:function(){var a=0;this._apply_pair(function(c){a++});return a},keys:function(){return this._apply_pair(function(a){return a[0]})},values:function(){return this._apply_pair(function(a){return a[1]})},_apply_pair:function(d){var c=[];_.each(_.values(this.pairs_of),function(a){_.each(a,function(e){c.push(d(e))})});return c},to_write:function(){return"#<Hashtable size="+this.size()+">"}});BiwaScheme.Hashtable.equal_hash=function(a){return BiwaScheme.to_write(a[0])};BiwaScheme.Hashtable.eq_hash=BiwaScheme.Hashtable.equal_hash;BiwaScheme.Hashtable.eqv_hash=BiwaScheme.Hashtable.equal_hash;BiwaScheme.Hashtable.string_hash=function(a){return a[0]};BiwaScheme.Hashtable.string_ci_hash=function(a){return _.isString(a[0])?a[0].toLowerCase():a[0]};BiwaScheme.Hashtable.symbol_hash=function(a){return(a[0] instanceof BiwaScheme.Symbol)?a[0].name:a[0]};BiwaScheme.Hashtable.eq_equiv=function(a){return BiwaScheme.eq(a[0],a[1])};BiwaScheme.Hashtable.eqv_equiv=function(a){return BiwaScheme.eqv(a[0],a[1])};BiwaScheme.Syntax=BiwaScheme.Class.create({initialize:function(a,c){this.sname=a;this.func=c},transform:function(a){if(!this.func){throw new BiwaScheme.Bug("sorry, syntax "+this.sname+" is a pseudo syntax now")}return this.func(a)},inspect:function(){return"#<Syntax "+this.sname+">"}});BiwaScheme.TopEnv.define=new BiwaScheme.Syntax("define");BiwaScheme.TopEnv.begin=new BiwaScheme.Syntax("begin");BiwaScheme.TopEnv.quote=new BiwaScheme.Syntax("quote");BiwaScheme.TopEnv.lambda=new BiwaScheme.Syntax("lambda");BiwaScheme.TopEnv["if"]=new BiwaScheme.Syntax("if");BiwaScheme.TopEnv["set!"]=new BiwaScheme.Syntax("set!");BiwaScheme.isNil=function(a){return(a===BiwaScheme.nil)};BiwaScheme.isUndef=function(a){return(a===BiwaScheme.undef)};BiwaScheme.isChar=function(a){return(a instanceof BiwaScheme.Char)};BiwaScheme.isSymbol=function(a){return(a instanceof BiwaScheme.Symbol)};BiwaScheme.isPort=function(a){return(a instanceof BiwaScheme.Port)};BiwaScheme.isPair=function(a){return(a instanceof BiwaScheme.Pair)};BiwaScheme.isList=function(a){if(a===BiwaScheme.nil){return true}if(!(a instanceof BiwaScheme.Pair)){return false}return BiwaScheme.isList(a.cdr)};BiwaScheme.isVector=function(a){return(a instanceof Array)&&(a.closure_p!==true)};BiwaScheme.isHashtable=function(a){return(a instanceof BiwaScheme.Hashtable)};BiwaScheme.isMutableHashtable=function(a){return(a instanceof BiwaScheme.Hashtable)&&a.mutable};BiwaScheme.isClosure=function(a){return(a instanceof Array)&&(a.closure_p===true)};BiwaScheme.isProcedure=function(a){return BiwaScheme.isClosure(a)||_.isFunction(a)};BiwaScheme.Parser=BiwaScheme.Class.create({initialize:function(a){this.tokens=this.tokenize(a);this.i=0},inspect:function(){return["#<Parser:",this.i,"/",this.tokens.length," ",BiwaScheme.inspect(this.tokens),">"].join("")},tokenize:function(a){var e=new Array(),c=null;var d=0;while(a!=""&&c!=a){c=a;a=a.replace(/^\s*(;[^\r\n]*(\r|\n|$)|#;|#\||#\\[^\w]|#?(\(|\[|{)|\)|\]|}|\'|`|,@|,|\+inf\.0|-inf\.0|\+nan\.0|\"(\\(.|$)|[^\"\\])*(\"|$)|[^\s()\[\]{}]+)/,function(g,f){var h=f;if(h=="#|"){d++;return""}else{if(d>0){if(/(.*\|#)/.test(h)){d--;if(d<0){throw new BiwaScheme.Error("Found an extra comment terminator: `|#'")}return h.substring(RegExp.$1.length,h.length)}else{return""}}else{if(h.charAt(0)!=";"){e[e.length]=h}return""}}})}return e},sexpCommentMarker:new Object,getObject:function(){var a=this.getObject0();if(a!=this.sexpCommentMarker){return a}a=this.getObject();if(a==BiwaScheme.Parser.EOS){throw new BiwaScheme.Error("Readable object not found after S exression comment")}a=this.getObject();return a},getList:function(f){var c=BiwaScheme.nil,a=c;while(this.i<this.tokens.length){this.eatObjectsInSexpComment("Input stream terminated unexpectedly(in list)");if(this.tokens[this.i]==")"||this.tokens[this.i]=="]"||this.tokens[this.i]=="}"){this.i++;break}if(this.tokens[this.i]=="."){this.i++;var e=this.getObject();if(e!=BiwaScheme.Parser.EOS&&c!=BiwaScheme.nil){a.cdr=e}}else{var d=new BiwaScheme.Pair(this.getObject(),BiwaScheme.nil);if(c==BiwaScheme.nil){c=d}else{a.cdr=d}a=d}}return c},getVector:function(c){var a=new Array();while(this.i<this.tokens.length){this.eatObjectsInSexpComment("Input stream terminated unexpectedly(in vector)");if(this.tokens[this.i]==")"||this.tokens[this.i]=="]"||this.tokens[this.i]=="}"){this.i++;break}a[a.length]=this.getObject()}return a},eatObjectsInSexpComment:function(a){while(this.tokens[this.i]=="#;"){this.i++;if((this.getObject()==BiwaScheme.Parser.EOS)||(this.i>=this.tokens.length)){throw new BiwaScheme.Error(a)}}},getObject0:function(){if(this.i>=this.tokens.length){return BiwaScheme.Parser.EOS}var a=this.tokens[this.i++];if(a=="#;"){return this.sexpCommentMarker}var c=a=="'"?"quote":a=="`"?"quasiquote":a==","?"unquote":a==",@"?"unquote-splicing":false;if(c||a=="("||a=="#("||a=="["||a=="#["||a=="{"||a=="#{"){return c?new BiwaScheme.Pair(BiwaScheme.Sym(c),new BiwaScheme.Pair(this.getObject(),BiwaScheme.nil)):(a=="("||a=="["||a=="{")?this.getList(a):this.getVector(a)}else{switch(a){case"+inf.0":return Infinity;case"-inf.0":return -Infinity;case"+nan.0":return NaN}var d;if(/^#x[0-9a-z]+$/i.test(a)){d=new Number("0x"+a.substring(2,a.length))}else{if(/^#d[0-9\.]+$/i.test(a)){d=new Number(a.substring(2,a.length))}else{d=new Number(a)}}if(!isNaN(d)){return d.valueOf()}else{if(a=="#f"||a=="#F"){return false}else{if(a=="#t"||a=="#T"){return true}else{if(a.toLowerCase()=="#\\newline"){return BiwaScheme.Char.get("\n")}else{if(a.toLowerCase()=="#\\space"){return BiwaScheme.Char.get(" ")}else{if(a.toLowerCase()=="#\\tab"){return BiwaScheme.Char.get("\t")}else{if(/^#\\.$/.test(a)){return BiwaScheme.Char.get(a.charAt(2))}else{if(/^\"(\\(.|$)|[^\"\\])*\"?$/.test(a)){return a.replace(/(\r?\n|\\n)/g,"\n").replace(/^\"|\\(.|$)|\"$/g,function(f,e){return e?e:""})}else{return BiwaScheme.Sym(a)}}}}}}}}}}});BiwaScheme.Parser.EOS=new Object();BiwaScheme.Compiler=BiwaScheme.Class.create({initialize:function(){},is_tail:function(a){return(a[0]=="return")},collect_free:function(h,g,d){var f=h;var j=d;var a=f.arr;for(var c=0;c<a.length;c++){j=this.compile_refer(a[c],g,["argument",j])}return j},compile_refer:function(a,d,c){return this.compile_lookup(a,d,function(e){return["refer-local",e,c]},function(e){return["refer-free",e,c]},function(e){return["refer-global",e,c]})},compile_lookup:function(a,g,j,k,d){var f=g[0],h=g[1];if((n=f.index(a))!=null){return j(n)}else{if((n=h.index(a))!=null){return k(n)}else{var c=a.name;return d(c)}}},make_boxes:function(f,g,e){var g=g;var j=0;var c=[];while(g instanceof BiwaScheme.Pair){if(f.member(g.car)){c.push(j)}j++;g=g.cdr}var h=e;for(var d=c.length-1;d>=0;d--){h=["box",c[d],h]}return h},find_sets:function(l,o){var j=null;if(l instanceof BiwaScheme.Symbol){j=new BiwaScheme.Set()}else{if(l instanceof BiwaScheme.Pair){switch(l.first()){case BiwaScheme.Sym("define"):var f=l.third();j=this.find_sets(f,o);case BiwaScheme.Sym("begin"):j=this.find_sets(l.cdr,o);break;case BiwaScheme.Sym("quote"):j=new BiwaScheme.Set();break;case BiwaScheme.Sym("lambda"):var k=l.second(),g=l.cdr.cdr;if(k instanceof BiwaScheme.Pair){j=this.find_sets(g,o.set_minus(k.to_set()))}else{j=this.find_sets(g,o.set_minus(new BiwaScheme.Set(k)))}break;case BiwaScheme.Sym("if"):var q=l.second(),e=l.third(),h=l.fourth();j=this.find_sets(q,o).set_union(this.find_sets(e,o),this.find_sets(h,o));break;case BiwaScheme.Sym("set!"):var c=l.second(),a=l.third();if(o.member(c)){j=this.find_sets(a,o).set_cons(c)}else{j=this.find_sets(a,o)}break;case BiwaScheme.Sym("call/cc"):var f=l.second();j=this.find_sets(f,o);break;default:var m=new BiwaScheme.Set();for(var d=l;d instanceof BiwaScheme.Pair;d=d.cdr){m=m.set_union(this.find_sets(d.car,o))}j=m;break}}else{j=new BiwaScheme.Set()}}if(j==null){throw new BiwaScheme.Bug("find_sets() exited in unusual way")}else{return j}},find_free:function(o,m,h){var k=null;if(o instanceof BiwaScheme.Symbol){if(h.member(o)){k=new BiwaScheme.Set(o)}else{k=new BiwaScheme.Set()}}else{if(o instanceof BiwaScheme.Pair){switch(o.first()){case BiwaScheme.Sym("define"):var e=o.third();k=this.find_free(e,m,h);break;case BiwaScheme.Sym("begin"):k=this.find_free(o.cdr,m,h);break;case BiwaScheme.Sym("quote"):k=new BiwaScheme.Set();break;case BiwaScheme.Sym("lambda"):var l=o.second(),g=o.cdr.cdr;if(l instanceof BiwaScheme.Pair){k=this.find_free(g,m.set_union(l.to_set()),h)}else{k=this.find_free(g,m.set_cons(l),h)}break;case BiwaScheme.Sym("if"):var r=o.second(),d=o.third(),j=o.fourth();k=this.find_free(r,m,h).set_union(this.find_free(d,m,h),this.find_free(j,m,h));break;case BiwaScheme.Sym("set!"):var a=o.second(),e=o.third();if(h.member(a)){k=this.find_free(e,m,h).set_cons(a)}else{k=this.find_free(e,m,h)}break;case BiwaScheme.Sym("call/cc"):var e=o.second();k=this.find_free(e,m,h);break;default:var q=new BiwaScheme.Set();for(var c=o;c instanceof BiwaScheme.Pair;c=c.cdr){q=q.set_union(this.find_free(c.car,m,h))}k=q;break}}else{k=new BiwaScheme.Set()}}if(k==null){throw new BiwaScheme.Bug("find_free() exited in unusual way")}else{return k}},find_dot_pos:function(c){var a=0;for(;c instanceof BiwaScheme.Pair;c=c.cdr,++a){}if(c!=BiwaScheme.nil){return a}else{return -1}},last_pair:function(a){if(a instanceof BiwaScheme.Pair){for(;a.cdr instanceof BiwaScheme.Pair;a=a.cdr){}}return a},dotted2proper:function(a){var e=function(g){var h=BiwaScheme.nil;for(;g instanceof BiwaScheme.Pair;){var j=g.cdr;g.cdr=h;h=g;g=j}return h};var d=function(g){var h=BiwaScheme.nil;for(;g instanceof BiwaScheme.Pair;g=g.cdr){h=new BiwaScheme.Pair(g.car,h)}return e(h)};if(a instanceof BiwaScheme.Pair){var f=this.last_pair(a);if(f instanceof BiwaScheme.Pair&&f.cdr===BiwaScheme.nil){return a}else{var c=d(a);this.last_pair(c).cdr=new BiwaScheme.Pair(f.cdr,BiwaScheme.nil);return c}}else{return new BiwaScheme.Pair(a,BiwaScheme.nil)}},compile:function(t,K,C,J,G){var O=null;while(1){if(t instanceof BiwaScheme.Symbol){return this.compile_refer(t,K,(C.member(t)?["indirect",G]:G))}else{if(t instanceof BiwaScheme.Pair){switch(t.first()){case BiwaScheme.Sym("define"):if(t.length()==1){throw new BiwaScheme.Error("Invalid `define': "+t.to_write())}var j=t.cdr.car;var q=t.cdr.cdr;if(j instanceof BiwaScheme.Symbol){if(q===BiwaScheme.nil){t=BiwaScheme.undef}else{if(q.cdr!==BiwaScheme.nil){throw new BiwaScheme.Error("Invalid `define': "+t.to_write())}t=q.car}BiwaScheme.TopEnv[j.name]=BiwaScheme.undef;G=["assign-global",j.name,G]}else{if(j instanceof BiwaScheme.Pair){var N=j.car,h=j.cdr;var z=new BiwaScheme.Pair(BiwaScheme.Sym("lambda"),new BiwaScheme.Pair(h,q));t=z;BiwaScheme.TopEnv[N.name]=BiwaScheme.undef;G=["assign-global",N.name,G]}else{throw new BiwaScheme.Error("compile: define needs a leftbol or pair: got "+j)}}break;case BiwaScheme.Sym("begin"):var M=[];for(var F=t.cdr;F instanceof BiwaScheme.Pair;F=F.cdr){M.push(F.car)}var L=G;for(var I=M.length-1;I>=0;I--){L=this.compile(M[I],K,C,J,L)}return L;case BiwaScheme.Sym("quote"):if(t.length()<2){throw new BiwaScheme.Error("Invalid quote: "+t.to_write())}var A=t.second();return["constant",A,G];case BiwaScheme.Sym("lambda"):if(t.length()<3){throw new BiwaScheme.Error("Invalid lambda: "+t.to_write())}var D=t.cdr.car;var u=new BiwaScheme.Pair(BiwaScheme.Sym("begin"),t.cdr.cdr);var m=this.find_dot_pos(D);var B=this.dotted2proper(D);var y=this.find_free(u,B.to_set(),J);var d=this.find_sets(u,B.to_set());var H=this.compile(u,[B.to_set(),y],d.set_union(C.set_intersect(y)),J.set_union(B.to_set()),["return"]);var r=["close",y.size(),this.make_boxes(d,B,H),G,m];return this.collect_free(y,K,r);case BiwaScheme.Sym("if"):if(t.length()<3||t.length()>4){throw new BiwaScheme.Error("Invalid if: "+t.to_write())}var E=t.second(),l=t.third(),o=t.fourth();var l=this.compile(l,K,C,J,G);var o=this.compile(o,K,C,J,G);t=E;G=["test",l,o];break;case BiwaScheme.Sym("set!"):if(t.length()!=3){throw new BiwaScheme.Error("Invalid set!: "+t.to_write())}var w=t.second(),t=t.third();var g=this.compile_lookup(w,K,function(a){return["assign-local",a,G]},function(a){return["assign-free",a,G]},function(a){return["assign-global",a,G]});G=g;break;case BiwaScheme.Sym("call/cc"):var t=t.second();var L=["conti",(this.is_tail(G)?(K[0].size()+1):0),["argument",["constant",1,["argument",this.compile(t,K,C,J,(this.is_tail(G)?["shift",1,["apply"]]:["apply"]))]]]];return this.is_tail(G)?L:["frame",L,G];default:var k=t.car;var h=t.cdr;var L=this.compile(k,K,C,J,this.is_tail(G)?["shift",h.length(),["apply"]]:["apply"]);L=this.compile(h.length(),K,C,J,["argument",L]);for(var F=h;F instanceof BiwaScheme.Pair;F=F.cdr){L=this.compile(F.car,K,C,J,["argument",L])}return this.is_tail(G)?L:["frame",L,G]}}else{return["constant",t,G]}}}},run:function(a){return this.compile(a,[new BiwaScheme.Set(),new BiwaScheme.Set()],new BiwaScheme.Set(),new BiwaScheme.Set(),["halt"])}});BiwaScheme.Compiler.compile=function(c,a){c=(new BiwaScheme.Interpreter).expand(c);return(new BiwaScheme.Compiler).run(c,a)};BiwaScheme.Pause=BiwaScheme.Class.create({initialize:function(a){this.on_pause=a},set_state:function(d,a,g,h,e){this.interpreter=d;this.x=a;this.f=g;this.c=h;this.s=e},ready:function(){this.on_pause(this)},resume:function(a){return this.interpreter.resume(true,a,this.x,this.f,this.c,this.s)}});BiwaScheme.Call=BiwaScheme.Class.create({initialize:function(a,c,d){this.proc=a;this.args=c;this.after=d||function(e){return e[0]}},inspect:function(){return"#<Call args="+this.args.inspect()+">"},toString:function(){return"#<Call>"},to_write:function(){return"#<Call>"}});BiwaScheme.Iterator={ForArray:BiwaScheme.Class.create({initialize:function(a){this.arr=a;this.i=0},has_next:function(){return this.i<this.arr.length},next:function(){return this.arr[this.i++]}}),ForString:BiwaScheme.Class.create({initialize:function(a){this.str=a;this.i=0},has_next:function(){return this.i<this.str.length},next:function(){return BiwaScheme.Char.get(this.str.charAt(this.i++))}}),ForList:BiwaScheme.Class.create({initialize:function(a){this.ls=a},has_next:function(){return(this.ls instanceof BiwaScheme.Pair)&&this.ls!=BiwaScheme.nil},next:function(){var a=this.ls;this.ls=this.ls.cdr;return a}}),ForMulti:BiwaScheme.Class.create({initialize:function(a){this.objs=a;this.size=a.length;this.iterators=_.map(a,function(c){return BiwaScheme.Iterator.of(c)})},has_next:function(){for(var a=0;a<this.size;a++){if(!this.iterators[a].has_next()){return false}}return true},next:function(){return _.map(this.iterators,function(a){return a.next()})}}),of:function(a){switch(true){case (a instanceof Array):return new this.ForArray(a);case (typeof(a)=="string"):return new this.ForString(a);case (a instanceof BiwaScheme.Pair):case (a===BiwaScheme.nil):return new this.ForList(a);default:throw new BiwaScheme.Bug("Iterator.of: unknown class: "+BiwaScheme.inspect(a))}}};BiwaScheme.Call.default_callbacks={call:function(a){return new BiwaScheme.Call(this.proc,[a])},result:function(){},finish:function(){}};BiwaScheme.Call.foreach=function(g,f,d){d||(d=false);_.each(["call","result","finish"],function(h){if(!f[h]){f[h]=BiwaScheme.Call.default_callbacks[h]}});var e=null;var a=null;var c=function(j){if(e){var k=f.result(j[0],a);if(k!==undefined){return k}}else{if(d){e=new BiwaScheme.Iterator.ForMulti(g)}else{e=BiwaScheme.Iterator.of(g)}}if(!e.has_next()){return f.finish()}else{a=e.next();var h=f.call(a);h.after=c;return h}};return c(null)};BiwaScheme.Call.multi_foreach=function(c,a){return BiwaScheme.Call.foreach(c,a,true)};BiwaScheme.Interpreter=BiwaScheme.Class.create({initialize:function(a){this.stack=[];this.on_error=a||function(c){};this.after_evaluate=function(){}},inspect:function(){return["#<Interpreter: stack size=>",this.stack.length," ","after_evaluate=",BiwaScheme.inspect(this.after_evaluate),">"].join("")},push:function(a,c){this.stack[c]=a;return c+1},save_stack:function(d){var a=[];for(var c=0;c<d;c++){a[c]=this.stack[c]}return a},restore_stack:function(a){var d=a.length;for(var c=0;c<d;c++){this.stack[c]=a[c]}return d},continuation:function(c,d){var a=this.push(d,c);return this.closure(["refer-local",0,["nuate",this.save_stack(a),["return"]]],0,null,-1)},shift_args:function(e,a,d){for(var c=e-1;c>=-1;c--){this.index_set(d,c+a+1,this.index(d,c))}return d-a-1},index:function(c,a){return this.stack[c-a-2]},index_set:function(d,c,a){this.stack[d-c-2]=a},closure:function(a,g,e,f){var c=[];c[0]=a;for(var d=0;d<g;d++){c[d+1]=this.index(e,d-1)}c[g+1]=f;c.closure_p=true;return c},execute:function(g,d,l,o,j){var h=null;try{h=this._execute(g,d,l,o,j)}catch(m){var k={a:g,x:d,f:l,c:o,s:j,stack:this.stack};return this.on_error(m,k)}return h},run_dump_hook:function(e,d,k,l,h){var g;var j;if(this.dumper){g=this.dumper}else{if(BiwaScheme.Interpreter.dumper){g=BiwaScheme.Interpreter.dumper}else{return}}if(g){j={a:e,f:k,c:l,s:h,x:d,stack:this.stack};g.dump(j)}},_execute:function(H,r,D,G,z){var I=null;while(true){this.run_dump_hook(H,r,D,G,z);switch(r[0]){case"halt":return H;case"refer-local":var A=r[1],r=r[2];H=this.index(D,A);break;case"refer-free":var A=r[1],r=r[2];H=G[A+1];break;case"refer-global":var w=r[1],r=r[2];if(BiwaScheme.TopEnv.hasOwnProperty(w)){var J=BiwaScheme.TopEnv[w]}else{if(BiwaScheme.CoreEnv.hasOwnProperty(w)){var J=BiwaScheme.CoreEnv[w]}else{throw new BiwaScheme.Error("execute: unbound symbol: "+BiwaScheme.inspect(w))}}H=J;break;case"indirect":var r=r[1];H=H[0];break;case"constant":var y=r[1],r=r[2];H=y;break;case"close":var g=r;var A=g[1],v=g[2],r=g[3],k=g[4];H=this.closure(v,A,z,k);z-=A;break;case"box":var A=r[1],r=r[2];this.index_set(z,A,[this.index(z,A)]);break;case"test":var l=r[1],m=r[2];r=((H!==false)?l:m);break;case"assign-global":var K=r[1],r=r[2];if(!BiwaScheme.TopEnv.hasOwnProperty(K)&&!BiwaScheme.CoreEnv.hasOwnProperty(K)){throw new BiwaScheme.Error("global variable '"+K+"' is not defined")}BiwaScheme.TopEnv[K]=H;H=BiwaScheme.undef;break;case"assign-local":var A=r[1],r=r[2];var t=this.index(D,A);t[0]=H;H=BiwaScheme.undef;break;case"assign-free":var A=r[1],r=r[2];var t=G[A+1];t[0]=H;H=BiwaScheme.undef;break;case"conti":var A=r[1],r=r[2];H=this.continuation(z,A);break;case"nuate":var p=r[1],r=r[2];z=this.restore_stack(p);break;case"frame":var I=r[2];r=r[1];z=this.push(I,this.push(D,this.push(G,z)));break;case"argument":var r=r[1];z=this.push(H,z);break;case"shift":var A=r[1],r=r[2];var e=this.index(z,A);z=this.shift_args(A,e,z);break;case"apply":var h=H;var e=this.index(z,-1);if(h instanceof Array){H=h;r=h[0];var k=h[h.length-1];if(k>=0){var o=BiwaScheme.nil;for(var C=e;--C>=k;){o=new BiwaScheme.Pair(this.index(z,C),o)}if(k>=e){for(var C=-1;C<e;C++){this.index_set(z,C-1,this.index(z,C))}z++;this.index_set(z,-1,this.index(z,-1)+1)}this.index_set(z,k,o)}D=z;G=H}else{if(h instanceof Function){var d=[];for(var C=0;C<e;C++){d.push(this.index(z,C))}var u=h(d,this);if(u instanceof BiwaScheme.Pause){var j=u;j.set_state(this,["return"],D,G,z);j.ready();return j}else{if(u instanceof BiwaScheme.Call){var F=["frame",["argument",["constant",1,["argument",["constant",u.after,["apply"]]]]],["return"]];var q=["constant",u.args.length,["argument",["constant",u.proc,["apply",u.args.length]]]];var E=_.inject(u.args,function(c,a){return["constant",a,["argument",c]]},q);r=["frame",E,F]}else{H=u;r=["return"]}}}else{throw new BiwaScheme.Error(BiwaScheme.inspect(h)+" is not a function")}}break;case"return":var A=this.index(z,-1);var B=z-A;r=this.index(B,0),D=this.index(B,1),G=this.index(B,2),z=B-3-1;break;default:throw new BiwaScheme.Bug("unknown opecode type: "+r[0])}}return H},expand:function(o,j){j||(j={});var g=null;if(o instanceof BiwaScheme.Pair){switch(o.car){case BiwaScheme.Sym("define"):var c=o.cdr.car,d=o.cdr.cdr;g=new BiwaScheme.Pair(BiwaScheme.Sym("define"),new BiwaScheme.Pair(c,this.expand(d,j)));break;case BiwaScheme.Sym("begin"):g=new BiwaScheme.Pair(BiwaScheme.Sym("begin"),this.expand(o.cdr,j));break;case BiwaScheme.Sym("quote"):g=o;break;case BiwaScheme.Sym("lambda"):var h=o.cdr.car,e=o.cdr.cdr;g=new BiwaScheme.Pair(BiwaScheme.Sym("lambda"),new BiwaScheme.Pair(h,this.expand(e,j)));break;case BiwaScheme.Sym("if"):var r=o.second(),a=o.third(),f=o.fourth();if(f==BiwaScheme.inner_of_nil){f=BiwaScheme.undef}g=BiwaScheme.List(BiwaScheme.Sym("if"),this.expand(r,j),this.expand(a,j),this.expand(f,j));break;case BiwaScheme.Sym("set!"):var q=o.second(),o=o.third();g=BiwaScheme.List(BiwaScheme.Sym("set!"),q,this.expand(o,j));break;case BiwaScheme.Sym("call-with-current-continuation"):case BiwaScheme.Sym("call/cc"):var o=o.second();g=BiwaScheme.List(BiwaScheme.Sym("call/cc"),this.expand(o,j));break;default:var l=null;if(BiwaScheme.isSymbol(o.car)){if(BiwaScheme.TopEnv[o.car.name] instanceof BiwaScheme.Syntax){l=BiwaScheme.TopEnv[o.car.name]}else{if(BiwaScheme.CoreEnv[o.car.name] instanceof BiwaScheme.Syntax){l=BiwaScheme.CoreEnv[o.car.name]}}}if(l){j.modified=true;g=l.transform(o);var p;for(;;){g=this.expand(g,p={});if(!p.modified){break}}}else{var m=this.expand(o.car,j);var k=BiwaScheme.shallow_array_to_list(_.map(o.cdr.to_array(),_.bind(function(s){return this.expand(s,j)},this)));g=new BiwaScheme.Pair(m,k)}}}else{g=o}return g},evaluate:function(c,a){this.parser=new BiwaScheme.Parser(c);this.compiler=new BiwaScheme.Compiler();if(a){this.after_evaluate=a}if(BiwaScheme.Debug){console.log("executing: "+c)}this.is_top=true;this.file_stack=[];return this.resume(false)},resume:function(e,j,k,d,h,o){var g=BiwaScheme.undef;for(;;){if(e){g=this.execute(j,k,d,h,o);e=false}else{if(!this.parser){break}var l=this.parser.getObject();if(l===BiwaScheme.Parser.EOS){break}l=this.expand(l);var m=this.compiler.run(l);g=this.execute(l,m,0,[],0)}if(g instanceof BiwaScheme.Pause){return g}}this.after_evaluate(g);return g},invoke_closure:function(f,d){d||(d=[]);var c=d.length;var a=["constant",c,["argument",["constant",f,["apply"]]]];for(var e=0;e<c;e++){a=["constant",d[e],["argument",a]]}return this.execute(f,["frame",a,["halt"]],0,f,0)},compile:function(c){var a=BiwaScheme.Interpreter.read(c);var d=BiwaScheme.Compiler.compile(a);return d}});BiwaScheme.Interpreter.read=function(c){var d=new BiwaScheme.Parser(c);var a=d.getObject();return(a==BiwaScheme.Parser.EOS)?BiwaScheme.eof:a};BiwaScheme.check_arity=function(c,d,a){var e=arguments.callee.caller?arguments.callee.caller.fname:"(?)";if(c<d){if(a&&a==d){throw new BiwaScheme.Error(e+": wrong number of arguments (expected: "+d+" got: "+c+")")}else{throw new BiwaScheme.Error(e+": too few arguments (at least: "+d+" got: "+c+")")}}else{if(a&&a<c){throw new BiwaScheme.Error(e+": too many arguments (at most: "+a+" got: "+c+")")}}};BiwaScheme.define_libfunc=function(h,c,a,d,g){var e=function(k,j){BiwaScheme.check_arity(k.length,c,a);var f=d(k,j);if(g){return f}else{if(f===undefined){throw new BiwaScheme.Bug("library function `"+h+"' returned JavaScript's undefined")}else{if(f===null){throw new BiwaScheme.Bug("library function `"+h+"' returned JavaScript's null")}else{return f}}}};d.fname=h;e.fname=h;e.inspect=function(){return this.fname};BiwaScheme.CoreEnv[h]=e};BiwaScheme.alias_libfunc=function(c,a){if(BiwaScheme.CoreEnv[c]){if(_.isArray(a)){_.map(a,function(d){BiwaScheme.alias_libfunc(c,d)})}else{if(_.isString(a)){BiwaScheme.CoreEnv[a]=BiwaScheme.CoreEnv[c]}else{throw new BiwaScheme.Bug("bad alias for library function `"+c+"': "+a.toString())}}}else{throw new BiwaScheme.Bug("library function `"+c+"' does not exist, so can't alias it.")}};BiwaScheme.define_libfunc_raw=function(e,c,a,d){BiwaScheme.define_libfunc(e,c,a,d,true)};BiwaScheme.define_syntax=function(a,d){var c=new BiwaScheme.Syntax(a,d);BiwaScheme.CoreEnv[a]=c};BiwaScheme.define_scmfunc=function(e,c,a,d){(new Interpreter).evaluate("(define "+e+" "+d+"\n)")};var make_assert=function(a){return function(){var c=arguments.callee.caller?arguments.callee.caller.fname:"";a.apply(this,[c].concat(_.toArray(arguments)))}};var make_simple_assert=function(c,d,a){return make_assert(function(g,f,e){if(a){g=a}option=e?("("+e+")"):"";if(!d(f)){throw new BiwaScheme.Error(g+option+": "+c+" required, but got "+BiwaScheme.to_write(f))}})};var assert_number=make_simple_assert("number",function(a){return typeof(a)=="number"||(a instanceof BiwaScheme.Complex)});var assert_integer=make_simple_assert("integer",function(a){return typeof(a)=="number"&&(a%1==0)});var assert_real=make_simple_assert("real number",function(a){return typeof(a)=="number"});var assert_between=make_assert(function(e,a,d,c){if(typeof(a)!="number"||a!=Math.round(a)){throw new BiwaScheme.Error(e+": number required, but got "+BiwaScheme.to_write(a))}if(a<d||c<a){throw new BiwaScheme.Error(e+": number must be between "+d+" and "+c+", but got "+BiwaScheme.to_write(a))}});var assert_string=make_simple_assert("string",_.isString);var assert_char=make_simple_assert("character",BiwaScheme.isChar);var assert_symbol=make_simple_assert("symbol",BiwaScheme.isSymbol);var assert_port=make_simple_assert("port",BiwaScheme.isPort);var assert_pair=make_simple_assert("pair",BiwaScheme.isPair);var assert_list=make_simple_assert("list",BiwaScheme.isList);var assert_vector=make_simple_assert("vector",BiwaScheme.isVector);var assert_hashtable=make_simple_assert("hashtable",BiwaScheme.isHashtable);var assert_mutable_hashtable=make_simple_assert("mutable hashtable",BiwaScheme.isMutableHashtable);var assert_record=make_simple_assert("record",BiwaScheme.isRecord);var assert_record_td=make_simple_assert("record type descriptor",BiwaScheme.isRecordTD);var assert_record_cd=make_simple_assert("record constructor descriptor",BiwaScheme.isRecordCD);var assert_enum_set=make_simple_assert("enum_set",BiwaScheme.isEnumSet);var assert_function=make_simple_assert("JavaScript function",_.isFunction);var assert_closure=make_simple_assert("scheme function",BiwaScheme.isClosure);var assert_procedure=make_simple_assert("scheme/js function",function(a){return BiwaScheme.isClosure(a)||_.isFunction(a)});var assert_date=make_simple_assert("date",function(a){return a instanceof Date});var assert=make_assert(function(e,d,c,a){if(!d){throw new BiwaScheme.Error((a||e)+": "+c)}});if(typeof(BiwaScheme)!="object"){BiwaScheme={}}with(BiwaScheme){define_syntax("cond",function(a){var d=a.cdr;if(!(d instanceof Pair)||d===nil){throw new Error("malformed cond: cond needs list but got "+to_write_ss(d))}var c=null;_.each(d.to_array().reverse(),function(g){if(!(g instanceof Pair)){throw new Error("bad clause in cond: "+to_write_ss(g))}if(g.car===Sym("else")){if(c!==null){throw new Error("'else' clause of cond followed by more clauses: "+to_write_ss(d))}else{if(g.cdr===nil){c=false}else{if(g.cdr.cdr===nil){c=g.cdr.car}else{c=new Pair(Sym("begin"),g.cdr)}}}}else{var h=g.car;if(g.cdr===nil){c=List(Sym("or"),h,c)}else{if(g.cdr.cdr===nil){c=List(Sym("if"),h,g.cdr.car,c)}else{if(g.cdr.car===Sym("=>")){var h=g.car,f=g.cdr.cdr.car;var e=BiwaScheme.gensym();c=List(Sym("let"),List(List(e,h)),List(Sym("if"),h,List(f,e),c))}else{c=List(Sym("if"),h,new Pair(Sym("begin"),g.cdr),c)}}}}});return c});define_syntax("case",function(a){var e=BiwaScheme.gensym();if(a.cdr===nil){throw new Error("case: at least one clause is required")}else{if(!(a.cdr instanceof Pair)){throw new Error("case: proper list is required")}else{var d=a.cdr.car;var f=a.cdr.cdr;var c=undefined;_.each(f.to_array().reverse(),function(g){if(g.car===Sym("else")){if(c===undefined){c=new Pair(Sym("begin"),g.cdr)}else{throw new Error("case: 'else' clause followed by more clauses: "+to_write_ss(f))}}else{c=List(Sym("if"),new Pair(Sym("or"),array_to_list(_.map(g.car.to_array(),function(h){return List(Sym("eqv?"),e,List(Sym("quote"),h))}))),new Pair(Sym("begin"),g.cdr),c)}});return new Pair(Sym("let1"),new Pair(e,new Pair(d,new Pair(c,nil))))}}});define_syntax("and",function(a){if(a.cdr==nil){return true}var e=a.cdr.to_array();var d=e.length-1;var c=e[d];for(d=d-1;d>=0;d--){c=List(Sym("if"),e[d],c,false)}return c});define_syntax("or",function(a){var e=a.cdr.to_array();var d=false;for(var c=e.length-1;c>=0;c--){d=List(Sym("if"),e[c],e[c],d)}return d});define_syntax("let",function(k){var a=null;if(k.cdr.car instanceof Symbol){a=k.cdr.car;k=k.cdr}var d=k.cdr.car,e=k.cdr.cdr;if((!(d instanceof Pair))&&d!=BiwaScheme.nil){throw new Error("let: need a pair for bindings: got "+to_write(d))}var h=nil,j=nil;for(var c=d;c instanceof Pair;c=c.cdr){h=new Pair(c.car.car,h);j=new Pair(c.car.cdr.car,j)}var g=null;if(a){h=array_to_list(h.to_array().reverse());j=array_to_list(j.to_array().reverse());var f=new Pair(Sym("lambda"),new Pair(h,e));var l=new Pair(a,j);g=List(Sym("letrec"),new Pair(List(a,f),nil),l)}else{g=new Pair(new Pair(Sym("lambda"),new Pair(h,e)),j)}return g});define_syntax("let*",function(c){var e=c.cdr.car,a=c.cdr.cdr;if(!(e instanceof Pair)){throw new Error("let*: need a pair for bindings: got "+to_write(e))}var d=null;_.each(e.to_array().reverse(),function(f){d=new Pair(Sym("let"),new Pair(new Pair(f,nil),d==null?a:new Pair(d,nil)))});return d});var expand_letrec_star=function(c){var f=c.cdr.car,a=c.cdr.cdr;if(!(f instanceof Pair)){throw new Error("letrec*: need a pair for bindings: got "+to_write(f))}var e=a;_.each(f.to_array().reverse(),function(g){e=new Pair(new Pair(Sym("set!"),g),e)});var d=nil;_.each(f.to_array().reverse(),function(g){d=new Pair(new Pair(g.car,new Pair(BiwaScheme.undef,nil)),d)});return new Pair(Sym("let"),new Pair(d,e))};define_syntax("letrec",expand_letrec_star);define_syntax("letrec*",expand_letrec_star);define_syntax("let-values",function(c){var g=c.cdr.car;var a=c.cdr.cdr;var d=null;var f=nil;var e=nil;_.each(g.to_array().reverse(),function(k){var o=k.cdr.car;var l=BiwaScheme.gensym();var m=new Pair(l,new Pair(new Pair(Sym("lambda"),new Pair(nil,new Pair(o,nil))),nil));f=new Pair(m,f);var j=k.car;e=new Pair(new Pair(j,new Pair(new Pair(l,nil),nil)),e)});var h=new Pair(Sym("let*-values"),new Pair(e,a));d=new Pair(Sym("let"),new Pair(f,new Pair(h,nil)));return d});define_syntax("let*-values",function(c){var e=c.cdr.car;var a=c.cdr.cdr;var d=null;_.each(e.to_array().reverse(),function(g){var f=g.car,h=g.cdr.car;d=new Pair(Sym("call-with-values"),new Pair(new Pair(Sym("lambda"),new Pair(nil,new Pair(h,nil))),new Pair(new Pair(Sym("lambda"),new Pair(f,(d==null?a:new Pair(d,nil)))),nil)))});return d});BiwaScheme.eq=function(d,c){return d===c};BiwaScheme.eqv=function(d,c){return d==c&&(typeof(d)==typeof(c))};define_libfunc("eqv?",2,2,function(a){return BiwaScheme.eqv(a[0],a[1])});define_libfunc("eq?",2,2,function(a){return BiwaScheme.eq(a[0],a[1])});define_libfunc("equal?",2,2,function(a){return to_write(a[0])==to_write(a[1])});define_libfunc("procedure?",1,1,function(a){return((a[0] instanceof Array)&&(a[0].closure_p===true)||(typeof a[0]=="function"))});define_libfunc("number?",1,1,function(a){return(typeof(a[0])=="number")||(a[0] instanceof Complex)||(a[0] instanceof Rational)});define_libfunc("complex?",1,1,function(a){return(a[0] instanceof Complex)});define_libfunc("real?",1,1,function(a){return(typeof(a[0])=="number")});define_libfunc("rational?",1,1,function(a){return(a[0] instanceof Rational)});define_libfunc("integer?",1,1,function(a){return typeof(a[0])=="number"&&a[0]==Math.round(a[0])&&a[0]!=Infinity&&a[0]!=-Infinity});define_libfunc("=",2,null,function(c){var a=c[0];assert_number(c[0]);for(var d=1;d<c.length;d++){assert_number(c[d]);if(c[d]!=a){return false}}return true});define_libfunc("<",2,null,function(a){assert_number(a[0]);for(var c=1;c<a.length;c++){assert_number(a[c]);if(!(a[c-1]<a[c])){return false}}return true});define_libfunc(">",2,null,function(a){assert_number(a[0]);for(var c=1;c<a.length;c++){assert_number(a[c]);if(!(a[c-1]>a[c])){return false}}return true});define_libfunc("<=",2,null,function(a){assert_number(a[0]);for(var c=1;c<a.length;c++){assert_number(a[c]);if(!(a[c-1]<=a[c])){return false}}return true});define_libfunc(">=",2,null,function(a){assert_number(a[0]);for(var c=1;c<a.length;c++){assert_number(a[c]);if(!(a[c-1]>=a[c])){return false}}return true});define_libfunc("zero?",1,1,function(a){assert_number(a[0]);return a[0]===0});define_libfunc("positive?",1,1,function(a){assert_number(a[0]);return(a[0]>0)});define_libfunc("negative?",1,1,function(a){assert_number(a[0]);return(a[0]<0)});define_libfunc("odd?",1,1,function(a){assert_number(a[0]);return(a[0]%2==1)||(a[0]%2==-1)});define_libfunc("even?",1,1,function(a){assert_number(a[0]);return a[0]%2==0});define_libfunc("finite?",1,1,function(a){assert_number(a[0]);return(a[0]!=Infinity)&&(a[0]!=-Infinity)&&!isNaN(a[0])});define_libfunc("infinite?",1,1,function(a){assert_number(a[0]);return(a[0]==Infinity)||(a[0]==-Infinity)});define_libfunc("nan?",1,1,function(a){assert_number(a[0]);return isNaN(a[0])});define_libfunc("max",2,null,function(a){for(var c=0;c<a.length;c++){assert_number(a[c])}return Math.max.apply(null,a)});define_libfunc("min",2,null,function(a){for(var c=0;c<a.length;c++){assert_number(a[c])}return Math.min.apply(null,a)});define_libfunc("+",0,null,function(a){var d=0;for(var c=0;c<a.length;c++){assert_number(a[c]);d+=a[c]}return d});define_libfunc("*",0,null,function(a){var d=1;for(var c=0;c<a.length;c++){assert_number(a[c]);d*=a[c]}return d});define_libfunc("-",1,null,function(c){var a=c.length;assert_number(c[0]);if(a==1){return -c[0]}else{var e=c[0];for(var d=1;d<a;d++){assert_number(c[d]);e-=c[d]}return e}});define_libfunc("/",1,null,function(c){var a=c.length;assert_number(c[0]);if(a==1){return 1/c[0]}else{var e=c[0];for(var d=1;d<a;d++){assert_number(c[d]);e/=c[d]}return e}});define_libfunc("abs",1,1,function(a){assert_number(a[0]);return Math.abs(a[0])});var div=function(c,a){return Math.floor(c/a)};var mod=function(c,a){return c-Math.floor(c/a)*a};var div0=function(c,a){return(c>0)?Math.floor(c/a):Math.ceil(c/a)};var mod0=function(c,a){return(c>0)?c-Math.floor(c/a)*a:c-Math.ceil(c/a)*a};define_libfunc("div0-and-mod0",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return new Values([div(a[0],a[1]),mod(a[0],a[1])])});define_libfunc("div",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return div(a[0],a[1])});define_libfunc("mod",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return mod(a[0],a[1])});define_libfunc("div0-and-mod0",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return new Values([div0(a[0],a[1]),mod0(a[0],a[1])])});define_libfunc("div0",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return div0(a[0],a[1])});define_libfunc("mod0",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return mod0(a[0],a[1])});define_libfunc("numerator",1,1,function(a){assert_number(a[0]);if(a[0] instanceof Rational){return a[0].numerator}else{throw new Bug("todo")}});define_libfunc("denominator",1,1,function(a){assert_number(a[0]);if(a[0] instanceof Rational){return a[0].denominator}else{throw new Bug("todo")}});define_libfunc("floor",1,1,function(a){assert_number(a[0]);return Math.floor(a[0])});define_libfunc("ceiling",1,1,function(a){assert_number(a[0]);return Math.ceil(a[0])});define_libfunc("truncate",1,1,function(a){assert_number(a[0]);return(a[0]<0)?Math.ceil(a[0]):Math.floor(a[0])});define_libfunc("round",1,1,function(a){assert_number(a[0]);return Math.round(a[0])});define_libfunc("exp",1,1,function(a){assert_number(a[0]);return Math.exp(a[0])});define_libfunc("log",1,2,function(a){var c=a[0],d=a[1];assert_number(c);if(d){assert_number(d);return Math.log(c)/Math.log(b)}else{return Math.log(c)}});define_libfunc("sin",1,1,function(a){assert_number(a[0]);return Math.sin(a[0])});define_libfunc("cos",1,1,function(a){assert_number(a[0]);return Math.cos(a[0])});define_libfunc("tan",1,1,function(a){assert_number(a[0]);return Math.tan(a[0])});define_libfunc("asin",1,1,function(a){assert_number(a[0]);return Math.asin(a[0])});define_libfunc("acos",1,1,function(a){assert_number(a[0]);return Math.acos(a[0])});define_libfunc("atan",1,2,function(a){assert_number(a[0]);if(a[1]){assert_number(a[1]);return Math.atan2(a[0],a[1])}else{return Math.atan(a[0])}});define_libfunc("sqrt",1,1,function(a){assert_number(a[0]);return Math.sqrt(a[0])});define_libfunc("exact-integer-sqrt",1,1,function(c){assert_number(c[0]);var a=Math.sqrt(c[0]);var e=a-(a%1);var d=c[0]-e*e;return new Values([e,d])});define_libfunc("expt",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return Math.pow(a[0],a[1])});define_libfunc("make-rectangular",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return new Complex(a[0],a[1])});define_libfunc("make-polar",2,2,function(a){assert_number(a[0]);assert_number(a[1]);return Complex.from_polar(a[0],a[1])});define_libfunc("real-part",1,1,function(a){assert_number(a[0]);return Complex.assure(a[0]).real});define_libfunc("imag-part",1,1,function(a){assert_number(a[0]);return Complex.assure(a[0]).imag});define_libfunc("magnitude",1,1,function(a){assert_number(a[0]);return Complex.assure(a[0]).magnitude()});define_libfunc("angle",1,1,function(a){assert_number(a[0]);return Complex.assure(a[0]).angle()});define_libfunc("number->string",1,3,function(c){var e=c[0],d=c[1],a=c[2];if(a){throw new Bug("number->string: precision is not yet implemented")}d=d||10;return e.toString(d)});define_libfunc("string->number",1,3,function(a){var d=a[0],c=a[1]||10;switch(d){case"+inf.0":return Infinity;case"-inf.0":return -Infinity;case"+nan.0":return NaN;default:if(d.match(/[eE.]/)){return parseFloat(d)}else{return parseInt(d,c)}}});define_libfunc("not",1,1,function(a){return(a[0]===false)?true:false});define_libfunc("boolean?",1,1,function(a){return(a[0]===false||a[0]===true)?true:false});define_libfunc("boolean=?",2,null,function(c){var a=c.length;for(var d=1;d<a;d++){if(c[d]!=c[0]){return false}}return true});define_libfunc("pair?",1,1,function(a){return(a[0] instanceof Pair)?true:false});define_libfunc("cons",2,2,function(a){return new Pair(a[0],a[1])});define_libfunc("car",1,1,function(a){if(!(a[0] instanceof Pair)){throw new Error("Attempt to apply car on "+a[0])}return a[0].car});define_libfunc("cdr",1,1,function(a){if(!(a[0] instanceof Pair)){throw new Error("Attempt to apply cdr on "+a[0])}return a[0].cdr});define_libfunc("set-car!",2,2,function(a){if(!(a[0] instanceof Pair)){throw new Error("Attempt to apply set-car! on "+a[0])}a[0].car=a[1];return BiwaScheme.undef});define_libfunc("set-cdr!",2,2,function(a){if(!(a[0] instanceof Pair)){throw new Error("Attempt to apply set-cdr! on "+a[0])}a[0].cdr=a[1];return BiwaScheme.undef});(function(){var a=function(c,d,f){var e=f;_.each(d,function(g){if(e instanceof Pair){e=(g?e.cdr:e.car)}else{throw new Error(c+": attempt to get "+(g?"cdr":"car")+" of "+e)}});return e};define_libfunc("caar",1,1,function(c){return a("caar",[0,0],c[0])});define_libfunc("cadr",1,1,function(c){return a("cadr",[1,0],c[0])});define_libfunc("cdar",1,1,function(c){return a("cadr",[0,1],c[0])});define_libfunc("cddr",1,1,function(c){return a("cadr",[1,1],c[0])});define_libfunc("caaar",1,1,function(c){return a("caaar",[0,0,0],c[0])});define_libfunc("caadr",1,1,function(c){return a("caadr",[1,0,0],c[0])});define_libfunc("cadar",1,1,function(c){return a("cadar",[0,1,0],c[0])});define_libfunc("caddr",1,1,function(c){return a("caddr",[1,1,0],c[0])});define_libfunc("cdaar",1,1,function(c){return a("cdaar",[0,0,1],c[0])});define_libfunc("cdadr",1,1,function(c){return a("cdadr",[1,0,1],c[0])});define_libfunc("cddar",1,1,function(c){return a("cddar",[0,1,1],c[0])});define_libfunc("cdddr",1,1,function(c){return a("cdddr",[1,1,1],c[0])});define_libfunc("caaaar",1,1,function(c){return a("caaaar",[0,0,0,0],c[0])});define_libfunc("caaadr",1,1,function(c){return a("caaadr",[1,0,0,0],c[0])});define_libfunc("caadar",1,1,function(c){return a("caadar",[0,1,0,0],c[0])});define_libfunc("caaddr",1,1,function(c){return a("caaddr",[1,1,0,0],c[0])});define_libfunc("cadaar",1,1,function(c){return a("cadaar",[0,0,1,0],c[0])});define_libfunc("cadadr",1,1,function(c){return a("cadadr",[1,0,1,0],c[0])});define_libfunc("caddar",1,1,function(c){return a("caddar",[0,1,1,0],c[0])});define_libfunc("cadddr",1,1,function(c){return a("cadddr",[1,1,1,0],c[0])});define_libfunc("cdaaar",1,1,function(c){return a("cdaaar",[0,0,0,1],c[0])});define_libfunc("cdaadr",1,1,function(c){return a("cdaadr",[1,0,0,1],c[0])});define_libfunc("cdadar",1,1,function(c){return a("cdadar",[0,1,0,1],c[0])});define_libfunc("cdaddr",1,1,function(c){return a("cdaddr",[1,1,0,1],c[0])});define_libfunc("cddaar",1,1,function(c){return a("cddaar",[0,0,1,1],c[0])});define_libfunc("cddadr",1,1,function(c){return a("cddadr",[1,0,1,1],c[0])});define_libfunc("cdddar",1,1,function(c){return a("cdddar",[0,1,1,1],c[0])});define_libfunc("cddddr",1,1,function(c){return a("cddddr",[1,1,1,1],c[0])})})();define_libfunc("null?",1,1,function(a){return(a[0]===nil)});define_libfunc("list?",1,1,function(a){var c=[];for(var d=a[0];d!=nil;d=d.cdr){if(d==nil){return true}if(!(d instanceof Pair)){return false}if(_.detect(c,function(e){return e===d.car})){return false}c.push(d.car)}return true});define_libfunc("list",0,null,function(c){var a=nil;for(var d=c.length-1;d>=0;d--){a=new Pair(c[d],a)}return a});define_libfunc("length",1,1,function(a){assert_list(a[0]);var d=0;for(var c=a[0];c!=nil;c=c.cdr){d++}return d});define_libfunc("append",2,null,function(c){var a=c.length;var d=c[--a];while(a--){_.each(c[a].to_array().reverse(),function(e){d=new Pair(e,d)})}return d});define_libfunc("reverse",1,1,function(c){assert_pair(c[0]);var a=nil;for(var d=c[0];d!=nil;d=d.cdr){a=new Pair(d.car,a)}return a});define_libfunc("list-tail",2,2,function(a){assert_pair(a[0]);assert_integer(a[1]);if(a[1]<0){throw new Error("list-tail: index out of range ("+a[1]+")")}var d=a[0];for(var c=0;c<a[1];c++){if(!(d instanceof Pair)){throw new Error("list-tail: the list is shorter than "+a[1])}d=d.cdr}return d});define_libfunc("list-ref",2,2,function(a){assert_pair(a[0]);assert_integer(a[1]);if(a[1]<0){throw new Error("list-tail: index out of range ("+a[1]+")")}var d=a[0];for(var c=0;c<a[1];c++){if(!(d instanceof Pair)){throw new Error("list-ref: the list is shorter than "+a[1])}d=d.cdr}return d.car});define_libfunc("map",2,null,function(f){var e=f.shift(),c=f;_.each(c,assert_list);var d=[];return Call.multi_foreach(c,{call:function(a){return new Call(e,_.map(a,function(g){return g.car}))},result:function(a){d.push(a)},finish:function(){return array_to_list(d)}})});define_libfunc("for-each",2,null,function(d){var c=d.shift(),a=d;_.each(a,assert_list);return Call.multi_foreach(a,{call:function(e){return new Call(c,_.map(e,function(f){return f.car}))},finish:function(){return BiwaScheme.undef}})});define_libfunc("symbol?",1,1,function(a){return(a[0] instanceof Symbol)?true:false});define_libfunc("symbol->string",1,1,function(a){assert_symbol(a[0]);return a[0].name});define_libfunc("symbol=?",2,null,function(a){assert_symbol(a[0]);for(var c=1;c<a.length;c++){assert_symbol(a[c]);if(a[c]!=a[0]){return false}}return true});define_libfunc("string->symbol",1,1,function(a){assert_string(a[0]);return Sym(a[0])});define_libfunc("char?",1,1,function(a){return(a[0] instanceof Char)});define_libfunc("char->integer",1,1,function(a){assert_char(a[0]);return a[0].value.charCodeAt(0)});define_libfunc("integer->char",1,1,function(a){assert_integer(a[0]);return Char.get(String.fromCharCode(a[0]))});var make_char_compare_func=function(a){return function(c){assert_char(c[0]);for(var d=1;d<c.length;d++){assert_char(c[d]);if(!a(c[d-1].value,c[d].value)){return false}}return true}};define_libfunc("char=?",2,null,make_char_compare_func(function(d,c){return d==c}));define_libfunc("char<?",2,null,make_char_compare_func(function(d,c){return d<c}));define_libfunc("char>?",2,null,make_char_compare_func(function(d,c){return d>c}));define_libfunc("char<=?",2,null,make_char_compare_func(function(d,c){return d<=c}));define_libfunc("char>=?",2,null,make_char_compare_func(function(d,c){return d>=c}));define_libfunc("string?",1,1,function(a){return(typeof(a[0])=="string")});define_libfunc("make-string",1,2,function(a){assert_integer(a[0]);var e=" ";if(a[1]){assert_char(a[1]);e=a[1].value}var d="";_.times(a[0],function(){d+=e});return d});define_libfunc("string",1,null,function(a){for(var c=0;c<a.length;c++){assert_char(a[c])}return _.map(a,function(d){return d.value}).join("")});define_libfunc("string-length",1,1,function(a){assert_string(a[0]);return a[0].length});define_libfunc("string-ref",2,2,function(a){assert_string(a[0]);assert_between(a[1],0,a[0].length-1);return Char.get(a[0].charAt([a[1]]))});define_libfunc("string=?",2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++){assert_string(a[c]);if(a[0]!=a[c]){return false}}return true});define_libfunc("string<?",2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++){assert_string(a[c]);if(!(a[c-1]<a[c])){return false}}return true});define_libfunc("string>?",2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++){assert_string(a[c]);if(!(a[c-1]>a[c])){return false}}return true});define_libfunc("string<=?",2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++){assert_string(a[c]);if(!(a[c-1]<=a[c])){return false}}return true});define_libfunc("string>=?",2,null,function(a){assert_string(a[0]);for(var c=1;c<a.length;c++){assert_string(a[c]);if(!(a[c-1]>=a[c])){return false}}return true});define_libfunc("substring",3,3,function(a){assert_string(a[0]);assert_integer(a[1]);assert_integer(a[2]);if(a[1]<0){throw new Error("substring: start too small: "+a[1])}if(a[2]<0){throw new Error("substring: end too small: "+a[2])}if(a[0].length+1<=a[1]){throw new Error("substring: start too big: "+a[1])}if(a[0].length+1<=a[2]){throw new Error("substring: end too big: "+a[2])}if(!(a[1]<=a[2])){throw new Error("substring: not start <= end: "+a[1]+", "+a[2])}return a[0].substring(a[1],a[2])});define_libfunc("string-append",0,null,function(a){for(var c=0;c<a.length;c++){assert_string(a[c])}return a.join("")});define_libfunc("string->list",1,1,function(a){assert_string(a[0]);return array_to_list(_.map(a[0].split(""),function(c){return Char.get(c[0])}))});define_libfunc("list->string",1,1,function(a){assert_list(a[0]);return _.map(a[0].to_array(),function(d){return d.value}).join("")});define_libfunc("string-for-each",2,null,function(c){var a=c.shift(),d=c;_.each(d,assert_string);return Call.multi_foreach(d,{call:function(e){return new Call(a,e)},finish:function(){return BiwaScheme.undef}})});define_libfunc("string-copy",1,1,function(a){assert_string(a[0]);return a[0]});define_libfunc("vector?",1,1,function(a){return(a[0] instanceof Array)&&(a[0].closure_p!==true)});define_libfunc("make-vector",1,2,function(a){assert_integer(a[0]);var d=new Array(a[0]);if(a.length==2){for(var c=0;c<a[0];c++){d[c]=a[1]}}return d});define_libfunc("vector",1,null,function(a){return a});define_libfunc("vector-length",1,1,function(a){assert_vector(a[0]);return a[0].length});define_libfunc("vector-ref",2,2,function(a){assert_vector(a[0]);assert_integer(a[1]);assert_between(a[1],0,a[0].length-1);return a[0][a[1]]});define_libfunc("vector-set!",3,3,function(a){assert_vector(a[0]);assert_integer(a[1]);a[0][a[1]]=a[2];return BiwaScheme.undef});define_libfunc("vector->list",1,1,function(a){assert_vector(a[0]);return array_to_list(a[0])});define_libfunc("list->vector",1,1,function(a){assert_list(a[0]);return a[0].to_array()});define_libfunc("vector-fill!",2,2,function(a){assert_vector(a[0]);var d=a[0],e=a[1];for(var c=0;c<d.length;c++){d[c]=e}return d});define_libfunc("vector-map",2,null,function(e){var d=e.shift(),f=e;_.each(f,assert_vector);var c=[];return Call.multi_foreach(f,{call:function(a){return new Call(d,a)},result:function(a){c.push(a)},finish:function(){return c}})});define_libfunc("vector-for-each",2,null,function(c){var a=c.shift(),d=c;_.each(d,assert_vector);return Call.multi_foreach(d,{call:function(e){return new Call(a,e)},finish:function(){return BiwaScheme.undef}})});define_libfunc("apply",2,null,function(c){var a=c.shift(),e=c.pop(),d=c;d=d.concat(e.to_array());return new Call(a,d)});define_syntax("call-with-current-continuation",function(a){return new Pair(Sym("call/cc"),a.cdr)});define_libfunc("values",0,null,function(a){return new Values(a)});define_libfunc("call-with-values",2,2,function(c){var a=c[0],d=c[1];return new Call(a,[],function(f){var e=f[0];if(!(e instanceof Values)){throw new Error("values expected, but got "+to_write(e))}return new Call(d,e.content)})});var expand_qq=function(c,d){if(c instanceof Symbol||c===nil){return List(Sym("quote"),c)}else{if(c instanceof Pair){var a=c.car;if(a instanceof Pair&&a.car===Sym("unquote-splicing")){var d=d-1;if(d==0){return List(Sym("append"),c.car.cdr.car,expand_qq(c.cdr,d+1))}else{return List(Sym("cons"),List(Sym("list"),Sym("unquote-splicing"),expand_qq(c.car.cdr.car,d)),expand_qq(c.cdr,d+1))}}else{if(a===Sym("unquote")){var d=d-1;if(d==0){return c.cdr.car}else{return List(Sym("list"),List(Sym("quote"),Sym("unquote")),expand_qq(c.cdr.car,d))}}else{if(a===Sym("quasiquote")){return List(Sym("list"),Sym("quasiquote"),expand_qq(c.cdr.car,d+1))}else{return List(Sym("cons"),expand_qq(c.car,d),expand_qq(c.cdr,d))}}}}else{if(c instanceof Array){throw new Bug("vector quasiquotation is not implemented yet")}else{return c}}}};define_syntax("quasiquote",function(a){return expand_qq(a.cdr.car,1)});define_syntax("unquote",function(a){throw new Error("unquote(,) must be inside quasiquote(`)")});define_syntax("unquote-splicing",function(a){throw new Error("unquote-splicing(,@) must be inside quasiquote(`)")});define_libfunc("string-upcase",1,1,function(a){assert_string(a[0]);return a[0].toUpperCase()});define_libfunc("string-downcase",1,1,function(a){assert_string(a[0]);return a[0].toLowerCase()});BiwaScheme.make_string_ci_function=function(a){return function(c){assert_string(c[0]);var e=c[0].toUpperCase();for(var d=1;d<c.length;d++){assert_string(c[d]);if(!a(e,c[d].toUpperCase())){return false}}return true}};define_libfunc("string-ci=?",2,null,make_string_ci_function(function(d,c){return d==c}));define_libfunc("string-ci<?",2,null,make_string_ci_function(function(d,c){return d<c}));define_libfunc("string-ci>?",2,null,make_string_ci_function(function(d,c){return d>c}));define_libfunc("string-ci<=?",2,null,make_string_ci_function(function(d,c){return d<=c}));define_libfunc("string-ci>=?",2,null,make_string_ci_function(function(d,c){return d>=c}));define_libfunc("find",2,2,function(d){var c=d[0],a=d[1];assert_list(a);return Call.foreach(a,{call:function(e){return new Call(c,[e.car])},result:function(f,e){if(f){return e.car}},finish:function(){return false}})});define_libfunc("for-all",2,null,function(d){var c=d.shift();var a=d;_.each(a,assert_list);var e=true;return Call.multi_foreach(a,{call:function(f){return new Call(c,_.map(f,function(g){return g.car}))},result:function(f,g){if(f===false){return false}e=f},finish:function(){return e}})});define_libfunc("exists",2,null,function(d){var c=d.shift();var a=d;_.each(a,assert_list);return Call.multi_foreach(a,{call:function(e){return new Call(c,_.map(e,function(f){return f.car}))},result:function(e,f){if(e!==false){return e}},finish:function(){return false}})});define_libfunc("filter",2,2,function(f){var e=f[0],d=f[1];assert_list(d);var c=[];return Call.foreach(d,{call:function(a){return new Call(e,[a.car])},result:function(g,a){if(g){c.push(a.car)}},finish:function(){return array_to_list(c)}})});define_libfunc("partition",2,2,function(d){var c=d[0],a=d[1];assert_list(a);var e=[],g=[];return Call.foreach(a,{call:function(f){return new Call(c,[f.car])},result:function(h,f){if(h){e.push(f.car)}else{g.push(f.car)}},finish:function(){return new Values([array_to_list(e),array_to_list(g)])}})});define_libfunc("fold-left",3,null,function(e){var c=e.shift(),d=e.shift(),a=e;_.each(a,assert_list);return Call.multi_foreach(a,{call:function(g){var f=_.map(g,function(h){return h.car});f.unshift(d);return new Call(c,f)},result:function(f,g){d=f},finish:function(){return d}})});define_libfunc("fold-right",3,null,function(e){var c=e.shift(),d=e.shift();var a=_.map(e,function(f){assert_list(f);return array_to_list(f.to_array().reverse())});return Call.multi_foreach(a,{call:function(g){var f=_.map(g,function(h){return h.car});f.push(d);return new Call(c,f)},result:function(f,g){d=f},finish:function(){return d}})});define_libfunc("remp",2,2,function(d){var c=d[0],a=d[1];assert_list(a);var e=[];return Call.foreach(a,{call:function(f){return new Call(c,[f.car])},result:function(g,f){if(!g){e.push(f.car)}},finish:function(){return array_to_list(e)}})});var make_remover=function(a){return function(d){var f=d[0],c=d[1];assert_list(c);var e=[];return Call.foreach(c,{call:function(g){return new Call(TopEnv[a]||CoreEnv[a],[f,g.car])},result:function(h,g){if(!h){e.push(g.car)}},finish:function(){return array_to_list(e)}})}};define_libfunc("remove",2,2,make_remover("equal?"));define_libfunc("remv",2,2,make_remover("eqv?"));define_libfunc("remq",2,2,make_remover("eq?"));define_libfunc("memp",2,2,function(d){var c=d[0],a=d[1];assert_list(a);var e=[];return Call.foreach(a,{call:function(f){return new Call(c,[f.car])},result:function(g,f){if(g){return f}},finish:function(){return false}})});var make_finder=function(a){return function(d){var f=d[0],c=d[1];assert_list(c);var e=[];return Call.foreach(c,{call:function(g){return new Call(TopEnv[a]||CoreEnv[a],[f,g.car])},result:function(h,g){if(h){return g}},finish:function(){return false}})}};define_libfunc("member",2,2,make_finder("equal?"));define_libfunc("memv",2,2,make_finder("eqv?"));define_libfunc("memq",2,2,make_finder("eq?"));define_libfunc("assp",2,2,function(c){var a=c[0],e=c[1];assert_list(e);var d=[];return Call.foreach(e,{call:function(f){if(f.car.car){return new Call(a,[f.car.car])}else{throw new Error("ass*: pair required but got "+to_write(f.car))}},result:function(g,f){if(g){return f.car}},finish:function(){return false}})});var make_assoc=function(a,c){return function(d){var g=d[0],f=d[1];assert_list(f);var e=[];return Call.foreach(f,{call:function(h){if(!BiwaScheme.isPair(h.car)){throw new Error(a+": pair required but got "+to_write(h.car))}var j=(TopEnv[c]||CoreEnv[c]);return new Call(j,[g,h.car.car])},result:function(j,h){if(j){return h.car}},finish:function(){return false}})}};define_libfunc("assoc",2,2,make_assoc("assoc","equal?"));define_libfunc("assv",2,2,make_assoc("assv","eqv?"));define_libfunc("assq",2,2,make_assoc("assq","eq?"));define_libfunc("cons*",1,null,function(a){if(a.length==1){return a[0]}else{var c=null;_.each(a.reverse(),function(d){if(c){c=new Pair(d,c)}else{c=d}});return c}});define_libfunc("list-sort",1,2,function(a){if(a[1]){throw new Bug("list-sort: cannot take compare proc now")}assert_list(a[0]);return array_to_list(a[0].to_array().sort())});define_libfunc("vector-sort",1,2,function(a){if(a[1]){throw new Bug("vector-sort: cannot take compare proc now")}assert_vector(a[0]);return _.clone(a[0]).sort()});define_libfunc("vector-sort!",1,2,function(a){if(a[1]){throw new Bug("vector-sort!: cannot take compare proc now")}assert_vector(a[0]);a[0].sort();return BiwaScheme.undef});define_syntax("when",function(c){var d=c.cdr.car,a=c.cdr.cdr;return new Pair(Sym("if"),new Pair(d,new Pair(new Pair(Sym("begin"),a),new Pair(BiwaScheme.undef,nil))))});define_syntax("unless",function(c){var d=c.cdr.car,a=c.cdr.cdr;return new Pair(Sym("if"),new Pair(new Pair(Sym("not"),new Pair(d,nil)),new Pair(new Pair(Sym("begin"),a),new Pair(BiwaScheme.undef,nil))))});define_syntax("do",function(h){if(!BiwaScheme.isPair(h.cdr)){throw new Error("do: no variables of do")}var l=h.cdr.car;if(!BiwaScheme.isPair(l)){throw new Error("do: variables must be given as a list")}if(!BiwaScheme.isPair(h.cdr.cdr)){throw new Error("do: no resulting form of do")}var a=h.cdr.cdr.car;var k=h.cdr.cdr.cdr;var d=BiwaScheme.gensym();var e=array_to_list(l.map(function(o){var m=o.to_array();return List(m[0],m[1])}));var f=a.car;var g=new Pair(Sym("begin"),a.cdr);var c=new Pair(d,array_to_list(l.map(function(o){var m=o.to_array();return m[2]||m[0]})));var j=new Pair(Sym("begin"),k).concat(List(c));return List(Sym("let"),d,e,List(Sym("if"),f,g,j))});define_syntax("case-lambda",function(a){});define_syntax("define-record-type",function(o){var t=o.cdr.car;var w=o.cdr.cdr;if(BiwaScheme.isSymbol(t)){var f=t;var A=Sym("make-"+t.name);var d=Sym(t.name+"?")}else{assert_list(t);var f=t.car;var A=t.cdr.car;var d=t.cdr.cdr.car;assert_symbol(f);assert_symbol(A);assert_symbol(d)}var z=false;var k=false;var a=false;var j=false;var g;var c=false;var s=false;var q=false;var u=[];_.each(w.to_array(),function(x){switch(x.car){case Sym("fields"):u=_.map(x.cdr.to_array(),function(C,B){if(BiwaScheme.isSymbol(C)){return{name:C,idx:B,mutable:false,accessor_name:null,mutator_name:null}}else{assert_list(C);assert_symbol(C.car);switch(C.car){case Sym("immutable"):var D=C.cdr.car;assert_symbol(D);if(BiwaScheme.isNil(C.cdr.cdr)){return{name:D,idx:B,mutable:false}}else{return{name:D,idx:B,mutable:false,accessor_name:C.cdr.cdr.car}}break;case Sym("mutable"):var D=C.cdr.car;assert_symbol(D);if(BiwaScheme.isNil(C.cdr.cdr)){return{name:D,idx:B,mutable:true}}else{return{name:D,idx:B,mutable:true,accessor_name:C.cdr.cdr.car,mutator_name:C.cdr.cdr.cdr.car}}break;default:throw new Error("define-record-type: field definition must start with `immutable' or 'mutable'")}}});break;case Sym("parent"):g=x.cdr.car;assert_symbol(g);break;case Sym("protocol"):q=x.cdr.car;break;case Sym("sealed"):z=!!x.cdr.car;break;case Sym("opaque"):k=!!x.cdr.car;break;case Sym("nongenerative"):a=true;j=x.cdr.car;break;case Sym("parent-rtd"):c=x.cdr.car;s=x.cdr.cdr.car;break;default:throw new BiwaScheme.Error("define-record-type: unknown clause `"+BiwaScheme.to_write(x.car)+"'")}});if(g){c=[Sym("record-type-descriptor"),g];s=[Sym("record-constructor-descriptor"),g]}var m=[Sym("record-type-descriptor"),f];var r=[Sym("record-constructor-descriptor"),f];var y=_.map(u,function(x){return List(Sym(x.mutable?"mutable":"immutable"),x.name)});y.is_vector=true;var v=[Sym("make-record-type-descriptor"),[Sym("quote"),f],c,j,z,k,y];var p=[Sym("make-record-constructor-descriptor"),Sym("__rtd"),s,q];var h=[Sym("let*"),[[Sym("__rtd"),v],[Sym("__cd"),p]],[Sym("_define-record-type"),[Sym("quote"),f],Sym("__rtd"),Sym("__cd")]];var l=_.map(u,function(B){var x=B.accessor_name||Sym(f.name+"-"+B.name.name);return[Sym("define"),x,[Sym("record-accessor"),m,B.idx]]});var e=_.filter(u,function(x){return x.mutable});e=_.map(e,function(B){var x=B.mutator_name||Sym("set-"+f.name+"-"+B.name.name+"!");return[Sym("define"),x,[Sym("record-mutator"),m,B.idx]]});return List.apply(null,[Sym("begin"),h,[Sym("define"),A,[Sym("record-constructor"),r]],[Sym("define"),d,[Sym("record-predicate"),m]],].concat(l).concat(e))});define_libfunc("_define-record-type",3,3,function(a){assert_symbol(a[0]);assert_record_td(a[1]);assert_record_cd(a[2]);BiwaScheme.Record.define_type(a[0].name,a[1],a[2]);return BiwaScheme.undef});define_syntax("record-type-descriptor",function(a){return List(Sym("_record-type-descriptor"),[Sym("quote"),a.cdr.car])});define_libfunc("_record-type-descriptor",1,1,function(a){assert_symbol(a[0]);var c=BiwaScheme.Record.get_type(a[0].name);if(c){return c.rtd}else{throw new Error("record-type-descriptor: unknown record type "+a[0].name)}});define_syntax("record-constructor-descriptor",function(a){return List(Sym("_record-constructor-descriptor"),[Sym("quote"),a.cdr.car])});define_libfunc("_record-constructor-descriptor",1,1,function(a){assert_symbol(a[0]);var c=BiwaScheme.Record.get_type(a[0].name);if(c){return c.cd}else{throw new Error("record-constructor-descriptor: unknown record type "+a[0].name)}});define_libfunc("make-record-type-descriptor",6,6,function(g){var c=g[0],d=g[1],l=g[2],e=g[3],j=g[4],k=g[5];assert_symbol(c);if(d){assert_record_td(d)}if(l){assert_symbol(l);var f=BiwaScheme.Record.RTD.NongenerativeRecords[l.name];if(f){return f}}e=!!e;j=!!j;assert_vector(k);for(var h=0;h<k.length;h++){var m=k[h];assert_symbol(m.car,"mutability");assert_symbol(m.cdr.car,"field name");k[h]=[m.cdr.car.name,(m.car==Sym("mutable"))]}var a=new BiwaScheme.Record.RTD(c,d,l,e,j,k);if(l){BiwaScheme.Record.RTD.NongenerativeRecords[l.name]=a}return a});define_libfunc("record-type-descriptor?",1,1,function(a){return(a[0] instanceof BiwaScheme.Record.RTD)});define_libfunc("make-record-constructor-descriptor",3,3,function(a){var c=a[0],d=a[1],e=a[2];assert_record_td(c);if(d){assert_record_cd(d)}if(e){assert_procedure(e)}return new BiwaScheme.Record.CD(c,d,e)});define_libfunc("record-constructor",1,1,function(a){var c=a[0];assert_record_cd(c);return c.record_constructor()});define_libfunc("record-predicate",1,1,function(a){var c=a[0];assert_record_td(c);return function(d){var e=d[0];return(e instanceof BiwaScheme.Record)&&(e.rtd===c)}});define_libfunc("record-accessor",2,2,function(c){var d=c[0],a=c[1];assert_record_td(d);assert_integer(a);for(var e=d.parent_rtd;e;e=e.parent_rtd){a+=e.fields.length}return function(g){var f=g[0];var h=d.name.name+"-"+d.field_name(a)+": "+BiwaScheme.to_write(f)+" is not a "+d.name.name;assert(BiwaScheme.isRecord(f),h);var j=false;for(var k=f.rtd;k;k=k.parent_rtd){if(k==d){j=true}}assert(j,h);return f.get(a)}});define_libfunc("record-mutator",2,2,function(c){var d=c[0],a=c[1];assert_record_td(d);assert_integer(a);for(var e=d.parent_rtd;e;e=e.parent_rtd){a+=e.fields.length}return function(h){var g=h[0],j=h[1];var f=d.field_name(a);assert_record(g);assert(g.rtd===d,f+": "+BiwaScheme.to_write(g)+" is not a "+d.name.name);assert(!g.rtd.sealed,f+": "+d.name.name+" is sealed (can't mutate)");g.set(a,j)}});define_libfunc("record?",1,1,function(a){var c=a[0];if(BiwaScheme.isRecord(c)){if(c.rtd.opaque){return false}else{return true}}else{return false}});define_libfunc("record-rtd",1,1,function(a){assert_record(a[0]);return a[0].rtd});define_libfunc("record-type-name",1,1,function(a){assert_record_td(a[0]);return a[0].name});define_libfunc("record-type-parent",1,1,function(a){assert_record_td(a[0]);return a[0].parent_rtd});define_libfunc("record-type-uid",1,1,function(a){assert_record_td(a[0]);return a[0].uid});define_libfunc("record-type-generative?",1,1,function(a){assert_record_td(a[0]);return a[0].generative});define_libfunc("record-type-sealed?",1,1,function(a){assert_record_td(a[0]);return a[0].sealed});define_libfunc("record-type-opaque?",1,1,function(a){assert_record_td(a[0]);return a[0].opaque});define_libfunc("record-type-field-names",1,1,function(a){assert_record_td(a[0]);return _.map(a[0].fields,function(c){return c.name})});define_libfunc("record-field-mutable?",2,2,function(c){var d=c[0],a=c[1];assert_record_td(c[0]);assert_integer(a);for(var e=d.parent_rtd;e;e=e.parent_rtd){a+=e.fields.length}return c[0].fields[a].mutable});define_libfunc("raise",1,1,function(a){throw new BiwaScheme.UserError(BiwaScheme.to_write(a[0]))});define_libfunc("port?",1,1,function(a){return(a[0] instanceof Port)});define_libfunc("textual-port?",1,1,function(a){assert_port(a[0]);return !a[0].is_binary});define_libfunc("binary-port?",1,1,function(a){assert_port(a[0]);return a[0].is_binary});define_libfunc("close-port",1,1,function(a){assert_port(a[0]);a[0].close();return BiwaScheme.undef});define_libfunc("call-with-port",2,2,function(d){var c=d[0],a=d[1];assert_port(c);assert_closure(a);return new Call(a,[c],function(e){c.close();return e[0]})});define_libfunc("put-char",2,2,function(a){assert_port(a[0]);assert_char(a[1]);a[0].put_string(a[1].value);return BiwaScheme.undef});define_libfunc("put-string",2,2,function(a){assert_port(a[0]);assert_string(a[1]);a[0].put_string(a[1]);return BiwaScheme.undef});define_libfunc("put-datum",2,2,function(a){assert_port(a[0]);a[0].put_string(to_write(a[1]));return BiwaScheme.undef});define_libfunc("eof-object",0,0,function(a){return eof});define_libfunc("eof-object?",1,1,function(a){return a[0]===eof});define_libfunc("input-port?",1,1,function(a){assert_port(a[0]);return a[0].is_input});define_libfunc("output-port?",1,1,function(a){assert_port(a[0]);return a[0].is_output});define_libfunc("current-input-port",0,0,function(a){return Port.current_input});define_libfunc("current-output-port",0,0,function(a){return Port.current_output});define_libfunc("current-error-port",0,0,function(a){return Port.current_error});define_libfunc("close-input-port",1,1,function(a){assert_port(a[0]);if(!a[0].is_input){throw new Error("close-input-port: port is not input port")}a[0].close();return BiwaScheme.undef});define_libfunc("close-output-port",1,1,function(a){assert_port(a[0]);if(!a[0].is_output){throw new Error("close-output-port: port is not output port")}a[0].close();return BiwaScheme.undef});define_libfunc("read",0,1,function(c){var a=c[0]||Port.current_input;assert_port(a);return a.get_string(function(d){return Interpreter.read(d)})});define_libfunc("newline",0,1,function(c){var a=c[0]||Port.current_output;a.put_string("\n");return BiwaScheme.undef});define_libfunc("display",1,2,function(c){var a=c[1]||Port.current_output;a.put_string(to_display(c[0]));return BiwaScheme.undef});define_libfunc("write",1,2,function(c){var a=c[1]||Port.current_output;assert_port(a);a.put_string(to_write(c[0]));return BiwaScheme.undef});define_libfunc("file-exists?",1,1,function(c){netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");assert_string(c[0]);var a=FileIO.open(c[0]);return a.exists()});define_libfunc("delete-file",1,1,function(c){netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");assert_string(c[0]);var a=FileIO.unlink(FileIO.open(c[0]));if(!a){throw new Error("delete-file: cannot delete "+c[0])}return BiwaScheme.undef});define_libfunc("make-eq-hashtable",0,1,function(a){return new Hashtable(Hashtable.eq_hash,Hashtable.eq_equiv)});define_libfunc("make-eqv-hashtable",0,1,function(a){return new Hashtable(Hashtable.eqv_hash,Hashtable.eqv_equiv)});define_libfunc("make-hashtable",2,3,function(a){assert_procedure(a[0]);assert_procedure(a[1]);return new Hashtable(a[0],a[1])});define_libfunc("hashtable?",1,1,function(a){return a[0] instanceof Hashtable});define_libfunc("hashtable-size",1,1,function(a){assert_hashtable(a[0]);return a[0].keys().length});BiwaScheme.find_hash_pair=function(d,a,c){return new Call(d.hash_proc,[a],function(e){var g=e[0];var f=d.candidate_pairs(g);if(!f){return c.on_not_found(g)}return Call.foreach(f,{call:function(h){return new Call(d.equiv_proc,[a,h[0]])},result:function(h,j){if(h){return c.on_found(j,g)}},finish:function(){return c.on_not_found(g)}})})};define_libfunc("hashtable-ref",3,3,function(a){var e=a[0],c=a[1],d=a[2];assert_hashtable(e);return BiwaScheme.find_hash_pair(e,c,{on_found:function(f){return f[1]},on_not_found:function(f){return d}})});define_libfunc("hashtable-set!",3,3,function(a){var e=a[0],c=a[1],d=a[2];assert_hashtable(e);return BiwaScheme.find_hash_pair(e,c,{on_found:function(f){f[1]=d;return BiwaScheme.undef},on_not_found:function(f){e.add_pair(f,c,d);return BiwaScheme.undef}})});define_libfunc("hashtable-delete!",2,2,function(a){var d=a[0],c=a[1];assert_hashtable(d);return BiwaScheme.find_hash_pair(d,c,{on_found:function(f,e){d.remove_pair(e,f);return BiwaScheme.undef},on_not_found:function(e){return BiwaScheme.undef}})});define_libfunc("hashtable-contains?",2,2,function(a){var d=a[0],c=a[1];assert_hashtable(d);return BiwaScheme.find_hash_pair(d,c,{on_found:function(e){return true},on_not_found:function(e){return false}})});define_libfunc("hashtable-update!",4,4,function(c){var f=c[0],d=c[1],a=c[2],e=c[3];assert_hashtable(f);assert_procedure(a);return BiwaScheme.find_hash_pair(f,d,{on_found:function(h,g){return new Call(a,[h[1]],function(j){h[1]=j[0];return BiwaScheme.undef})},on_not_found:function(g){return new Call(a,[e],function(h){f.add_pair(g,d,h[0]);return BiwaScheme.undef})}})});define_libfunc("hashtable-copy",1,2,function(c){var a=(c[1]===undefined)?false:!!c[1];assert_hashtable(c[0]);return c[0].create_copy(a)});define_libfunc("hashtable-clear!",0,1,function(a){assert_hashtable(a[0]);a[0].clear();return BiwaScheme.undef});define_libfunc("hashtable-keys",1,1,function(a){assert_hashtable(a[0]);return a[0].keys()});define_libfunc("hashtable-entries",1,1,function(a){assert_hashtable(a[0]);return new Values([a[0].keys(),a[0].values()])});define_libfunc("hashtable-equivalence-function",1,1,function(a){assert_hashtable(a[0]);return a[0].equiv_proc});define_libfunc("hashtable-hash-function",1,1,function(a){assert_hashtable(a[0]);return a[0].hash_proc});define_libfunc("hashtable-mutable?",1,1,function(a){assert_hashtable(a[0]);return a[0].mutable});define_libfunc("equal-hash",0,0,function(a){return Hashtable.equal_hash});define_libfunc("string-hash",0,0,function(a){return Hashtable.string_hash});define_libfunc("string-ci-hash",0,0,function(a){return Hashtable.string_ci_hash});define_libfunc("symbol-hash",0,0,function(a){return Hashtable.symbol_hash});define_libfunc("make-enumeration",1,1,function(c){assert_list(c[0]);var a=c[0].to_array();var d=new BiwaScheme.Enumeration.EnumType(a);return d.universe()});define_libfunc("enum-set-universe",1,1,function(a){assert_enum_set(a[0]);return a[0].enum_type.universe()});define_libfunc("enum-set-indexer",1,1,function(a){assert_enum_set(a[0]);return a[0].enum_type.indexer()});define_libfunc("enum-set-constructor",1,1,function(a){assert_enum_set(a[0]);return a[0].enum_type.constructor()});define_libfunc("enum-set->list",1,1,function(a){assert_enum_set(a[0]);return a[0].symbol_list()});define_libfunc("enum-set-member?",2,2,function(a){assert_symbol(a[0]);assert_enum_set(a[1]);return a[1].is_member(a[0])});define_libfunc("enum-set-subset?",2,2,function(a){assert_enum_set(a[0]);assert_enum_set(a[1]);return a[0].is_subset(a[1])});define_libfunc("enum-set=?",2,2,function(a){assert_enum_set(a[0]);assert_enum_set(a[1]);return a[0].equal_to(a[1])});define_libfunc("enum-set-union",2,2,function(a){assert_enum_set(a[0]);assert_enum_set(a[1]);assert(a[0].enum_type===a[1].enum_type,"two enum-sets must be the same enum-type","enum-set-union");return a[0].union(a[1])});define_libfunc("enum-set-intersection",2,2,function(a){assert_enum_set(a[0]);assert_enum_set(a[1]);return a[0].intersection(a[1])});define_libfunc("enum-set-difference",2,2,function(a){assert_enum_set(a[0]);assert_enum_set(a[1]);return a[0].difference(a[1])});define_libfunc("enum-set-complement",1,1,function(a){assert_enum_set(a[0]);return a[0].complement()});define_libfunc("enum-set-projection",2,2,function(a){assert_enum_set(a[0]);assert_enum_set(a[1]);return a[0].projection(a[1])});define_syntax("define-enumeration",function(a){var d=a.cdr.car;assert(BiwaScheme.isSymbol(d),"expected symbol for type_name","define-enumeration");d=d.name;var c=a.cdr.cdr.car;assert(BiwaScheme.isList(c),"expected list of symbol for members","define-enumeration");c=c.to_array();var f=a.cdr.cdr.cdr.car;assert(BiwaScheme.isSymbol(f),"expected symbol for constructor_name","define-enumeration");f=f.name;var e=new BiwaScheme.Enumeration.EnumType(c);define_syntax(d,function(h){assert(!BiwaScheme.isNil(h.cdr),"an argument is needed",d);var g=h.cdr.car;assert_symbol(g,d);assert(_.include(e.members,g),g.name+" is not included in the universe: "+BiwaScheme.to_write(e.members),d);return BiwaScheme.List(Sym("quote"),g)});define_syntax(f,function(g){assert_list(g.cdr,f);var h=g.cdr.to_array();_.each(h,function(j){assert_symbol(j,f);assert(_.include(e.members,j),j.name+" is not included in the universe: "+BiwaScheme.to_write(e.members),f)});return new BiwaScheme.Enumeration.EnumSet(e,h)})});define_libfunc("eval",1,1,function(c,a){var d=c[0];var a=new BiwaScheme.Interpreter(a.on_error);return a.evaluate(d.to_write())})}if(typeof(BiwaScheme)!="object"){BiwaScheme={}}with(BiwaScheme){define_libfunc_raw("js-eval",1,1,function(ar){return eval(ar[0])});define_libfunc_raw("js-ref",2,2,function(a){if(_.isString(a[1])){return a[0][a[1]]}else{assert_symbol(a[1]);return a[0][a[1].name]}});define_libfunc("js-set!",3,3,function(a){assert_string(a[1]);a[0][a[1]]=a[2];return BiwaScheme.undef});define_libfunc_raw("js-call",1,null,function(a){var c=a.shift();assert_function(c);var d=null;return c.apply(d,a)});define_libfunc_raw("js-invoke",2,null,function(d){var c=d.shift();var a=d.shift();if(!_.isString(a)){assert_symbol(a);a=a.name}if(c[a]){return c[a].apply(c,d)}else{throw new Error("js-invoke: function "+a+" is not defined")}});define_libfunc_raw("js-invocation",2,null,function(ar,intp){var receiver=ar.shift();if(BiwaScheme.isSymbol(receiver)){receiver=eval(receiver.name)}var v=receiver;_.each(ar,function(callspec){if(BiwaScheme.isSymbol(callspec)){v=v[callspec.name]}else{if(BiwaScheme.isList(callspec)){var args=callspec.to_array();assert_symbol(args[0]);var method=args.shift().name;args=_.map(args,function(arg){if(BiwaScheme.isClosure(arg)){return BiwaScheme.js_closure(arg,intp)}else{if(BiwaScheme.isList(arg)){var o={};arg.foreach(function(pair){assert_symbol(pair.car);o[pair.car.name]=pair.cdr});return o}else{return arg}}});if(!_.isFunction(v[method])){throw new BiwaScheme.Error("js-invocation: the method `"+method+"' not found")}v=v[method].apply(v,args)}else{throw new BiwaScheme.Error("js-invocation: expected list or symbol for callspec but got "+BiwaScheme.inspect(callspec))}}});return v});define_libfunc("js-new",1,null,function(ar,intp){var array_to_obj=function(ary){if((ary.length%2)!=0){throw new Error("js-new: odd number of key-value pair")}var obj={};for(var i=0;i<ary.length;i+=2){var key=ary[i],value=ary[i+1];assert_symbol(key);if(value.closure_p===true){value=BiwaScheme.js_closure(value,intp)}obj[key.name]=value}return obj};var ctor=ar.shift();assert_string(ctor);if(ar.length==0){return eval("new "+ctor+"()")}else{var args=[];for(var i=0;i<ar.length;i++){if(ar[i] instanceof Symbol){args.push(array_to_obj(ar.slice(i)));break}else{args.push(ar[i])}}var args_str=_.map(ar,function(value,i){return"args['"+i+"']"}).join(",");return eval("new "+ctor+"("+args_str+")")}});define_libfunc("js-obj",0,null,function(a){if(a.length%2!=0){throw new Error("js-obj: number of arguments must be even")}var c={};for(i=0;i<a.length/2;i++){assert_string(a[i*2]);c[a[i*2]]=a[i*2+1]}return c});BiwaScheme.js_closure=function(a,d){var c=d.on_error;return function(){var e=new Interpreter(c);var f=_.map(_.toArray(arguments),function(g){if(_.isUndefined(g)){return BiwaScheme.Sym("undefined")}else{if(_.isNull(g)){return BiwaScheme.Sym("null")}else{return g}}});return e.invoke_closure(a,f)}};define_libfunc("js-closure",1,1,function(c,a){assert_closure(c[0]);return BiwaScheme.js_closure(c[0],a)});define_libfunc("js-null?",1,1,function(a){return a[0]===null});define_libfunc("js-undefined?",1,1,function(a){return a[0]===undefined});define_libfunc("js-function?",1,1,function(a){return _.isFunction(a[0])});define_libfunc_raw("js-array-to-list",1,1,function(a){return BiwaScheme.array_to_list(a[0])});define_libfunc_raw("list-to-js-array",1,1,function(a){return a[0].to_array()});BiwaScheme.alist_to_js_obj=function(a){if(a===nil){return{}}assert_list(a);var c={};a.foreach(function(d){assert_string(d.car);c[d.car]=d.cdr});return c};define_libfunc("alist-to-js-obj",1,1,function(a){return BiwaScheme.alist_to_js_obj(a[0])});BiwaScheme.js_obj_to_alist=function(d){if(d===undefined){return BiwaScheme.nil}var a=[];_.each(d,function(f,e){a.push(new Pair(e,f))});var c=BiwaScheme.array_to_list(a);return c};define_libfunc("js-obj-to-alist",1,1,function(a){return BiwaScheme.js_obj_to_alist(a[0])});define_libfunc("timer",2,2,function(d,c){var a=d[0],e=d[1];assert_closure(a);assert_real(e);setTimeout(function(){(new Interpreter(c.on_error)).invoke_closure(a)},e*1000);return BiwaScheme.undef});define_libfunc("set-timer!",2,2,function(d,c){var a=d[0],e=d[1];assert_closure(a);assert_real(e);return setInterval(function(){(new Interpreter(c.on_error)).invoke_closure(a)},e*1000)});define_libfunc("clear-timer!",1,1,function(a){var c=a[0];clearInterval(c);return BiwaScheme.undef});define_libfunc("sleep",1,1,function(a){var c=a[0];assert_real(c);return new BiwaScheme.Pause(function(d){setTimeout(function(){d.resume(nil)},c*1000)})});var define_console_func=function(a){define_libfunc("console-"+a,1,null,function(d){var c=window.console;if(c){var e=_.map(d,function(f){return BiwaScheme.inspect(f,{fallback:f})});c[a].apply(c,e)}return d[0]})};define_console_func("debug");define_console_func("log");define_console_func("info");define_console_func("warn");define_console_func("error")}if(typeof(BiwaScheme)!="object"){BiwaScheme={}}with(BiwaScheme){define_libfunc("html-escape",1,1,function(a){assert_string(a[0]);return _.escapeHTML(a[0])});BiwaScheme.inspect_objs=function(a){return _.map(a,BiwaScheme.inspect).join(", ")};define_libfunc("inspect",1,null,function(a){return BiwaScheme.inspect_objs(a)});define_libfunc("inspect!",1,null,function(a){BiwaScheme.Port.current_output.put_string(BiwaScheme.inspect_objs(a));return BiwaScheme.undef});BiwaScheme.json2sexp=function(c){switch(true){case _.isNumber(c)||_.isString(c)||c===true||c===false:return c;case _.isArray(c):return array_to_list(_.map(c,json2sexp));case typeof(c)=="object":var a=nil;for(key in c){a=new Pair(new Pair(key,json2sexp(c[key])),a)}return a;default:throw new Error("json->sexp: detected invalid value for json: "+BiwaScheme.inspect(c))}throw new Bug("must not happen")};define_libfunc("json->sexp",1,1,function(a){return json2sexp(a[0])});define_libfunc("identity",1,1,function(a){return a[0]});define_syntax("inc!",function(a){var c=a.cdr.car;return List(Sym("set!"),c,[Sym("+"),c,1])});define_syntax("dec!",function(a){var c=a.cdr.car;return List(Sym("set!"),c,[Sym("-"),c,1])});define_libfunc("string-concat",1,1,function(a){assert_list(a[0]);return a[0].to_array().join("")});define_libfunc("string-split",2,2,function(a){assert_string(a[0]);assert_string(a[1]);return array_to_list(a[0].split(a[1]))});define_libfunc("string-join",1,2,function(a){assert_list(a[0]);var c="";if(a[1]){assert_string(a[1]);c=a[1]}return a[0].to_array().join(c)});define_libfunc("intersperse",2,2,function(c){var e=c[0],a=c[1];assert_list(a);var d=[];_.each(a.to_array().reverse(),function(f){d.push(f);d.push(e)});d.pop();return array_to_list(d)});define_libfunc("map-with-index",2,null,function(d){var c=d.shift(),a=d;_.each(a,assert_list);var f=[],e=0;return Call.multi_foreach(a,{call:function(h){var g=_.map(h,function(j){return j.car});g.unshift(e);e++;return new Call(c,g)},result:function(g){f.push(g)},finish:function(){return array_to_list(f)}})});define_syntax("dotimes",function(g){var j=g.cdr.car,a=g.cdr.cdr;var c=j.car,d=j.cdr.car,k=j.cdr.cdr.car;var h=BiwaScheme.gensym();var f=List([h,d],[c,0,[Sym("+"),c,1]]);var e=List([Sym(">="),c,h],k);return new Pair(Sym("do"),new Pair(f,new Pair(e,a)))});var sort_with_comp=function(c,a){return c.sort(function(e,d){var f=new BiwaScheme.Interpreter();return f.invoke_closure(a,[e,d])})};define_libfunc("list-sort/comp",1,2,function(a){assert_procedure(a[0]);assert_list(a[1]);return array_to_list(sort_with_comp(a[1].to_array(),a[0]))});define_libfunc("vector-sort/comp",1,2,function(a){assert_procedure(a[0]);assert_vector(a[1]);return sort_with_comp(_.clone(a[1]),a[0])});define_libfunc("vector-sort/comp!",1,2,function(a){assert_procedure(a[0]);assert_vector(a[1]);sort_with_comp(a[1],a[0]);return BiwaScheme.undef});var rearrange_args=function(d,f){var a=[];var e=(new Compiler).find_dot_pos(d);if(e==-1){a=f}else{for(var c=0;c<e;c++){a[c]=f[c]}a[c]=array_to_list(f.slice(c))}return a};define_syntax("define-macro",function(c){var h=c.cdr.car;var e;if(h instanceof Pair){var g=h.car;e=h.cdr;var a=c.cdr.cdr;var f=new Pair(Sym("lambda"),new Pair(e,a))}else{var g=h;var f=c.cdr.cdr.car;e=f.cdr.car}var j=Compiler.compile(f);if(j[1]!=0){throw new Bug("you cannot use free variables in macro expander (or define-macro must be on toplevel)")}var d=[j[2]];TopEnv[g.name]=new Syntax(g.name,function(p){var o=p.to_array();o.shift();var l=new Interpreter();var m=rearrange_args(e,o);var k=l.invoke_closure(d,m);return k});return BiwaScheme.undef});var macroexpand_1=function(c){if(c instanceof Pair){if(c.car instanceof Symbol&&TopEnv[c.car.name] instanceof Syntax){var a=TopEnv[c.car.name];c=a.transform(c)}else{throw new Error("macroexpand-1: `"+to_write_ss(c)+"' is not a macro")}}return c};define_syntax("%macroexpand",function(a){var c=(new Interpreter).expand(a.cdr.car);return List(Sym("quote"),c)});define_syntax("%macroexpand-1",function(a){var c=macroexpand_1(a.cdr.car);return List(Sym("quote"),c)});define_libfunc("macroexpand",1,1,function(a){return(new Interpreter).expand(a[0])});define_libfunc("macroexpand-1",1,1,function(a){return macroexpand_1(a[0])});define_libfunc("gensym",0,0,function(a){return BiwaScheme.gensym()});define_libfunc("print",1,null,function(a){_.map(a,function(c){BiwaScheme.Port.current_output.put_string(to_display(c),true)});BiwaScheme.Port.current_output.put_string("\n");return BiwaScheme.undef});define_libfunc("write-to-string",1,1,function(a){return to_write(a[0])});define_libfunc("read-from-string",1,1,function(a){assert_string(a[0]);return Interpreter.read(a[0])});define_libfunc("port-closed?",1,1,function(a){assert_port(a[0]);return !(a[0].is_open)});define_syntax("let1",function(c){var d=c.cdr.car;var e=c.cdr.cdr.car;var a=c.cdr.cdr.cdr;return new Pair(new Pair(Sym("lambda"),new Pair(new Pair(d,nil),a)),new Pair(e,nil))});var assert_regexp=function(a,c){if(!(a instanceof RegExp)){throw new Error(c+": regexp required, but got "+to_write(a))}};define_libfunc("string->regexp",1,1,function(a){assert_string(a[0],"string->regexp");return new RegExp(a[0])});define_libfunc("regexp?",1,1,function(a){return(a[0] instanceof RegExp)});define_libfunc("regexp->string",1,1,function(a){assert_regexp(a[0],"regexp->string");return a[0].toString().slice(1,-1)});define_libfunc("regexp-exec",2,2,function(a){var d=a[0];if(_.isString(a[0])){d=new RegExp(a[0])}assert_regexp(d,"regexp-exec");assert_string(a[1],"regexp-exec");var c=d.exec(a[1]);return(c===null)?false:array_to_list(c)})}with(BiwaScheme){define_libfunc("iota",1,3,function(d){var g=d[0];var j=d[1]||0;var f=(d[2]===undefined)?1:d[2];assert_integer(g);assert_number(j);assert_number(f);var c=[],h=j;for(var e=0;e<g;e++){c.push(h);h+=f}return array_to_list(c)});var copy_pair=function(d){var a=BiwaScheme.isPair(d.car)?copy_pair(d.car):d.car;var c=BiwaScheme.isPair(d.cdr)?copy_pair(d.cdr):d.cdr;return new Pair(a,c)};define_libfunc("list-copy",1,1,function(a){if(BiwaScheme.isPair(a[0])){return copy_pair(a[0])}else{return BiwaScheme.nil}});define_libfunc("open-input-string",1,1,function(a){assert_string(a[0]);return new Port.StringInput(a[0])});define_libfunc("open-output-string",0,0,function(a){return new Port.StringOutput()});define_libfunc("get-output-string",1,1,function(a){assert_port(a[0]);if(!(a[0] instanceof Port.StringOutput)){throw new Error("get-output-string: port must be made by 'open-output-string'")}return a[0].output_string()});define_libfunc("current-date",0,1,function(a){return new Date()});define_libfunc("date?",1,1,function(a){return(a[0] instanceof Date)});define_libfunc("date-nanosecond",1,1,function(a){assert_date(a[0]);return a[0].getMilliseconds()*1000000});define_libfunc("date-millisecond",1,1,function(a){assert_date(a[0]);return a[0].getMilliseconds()});define_libfunc("date-second",1,1,function(a){assert_date(a[0]);return a[0].getSeconds()});define_libfunc("date-minute",1,1,function(a){assert_date(a[0]);return a[0].getMinutes()});define_libfunc("date-hour",1,1,function(a){assert_date(a[0]);return a[0].getHours()});define_libfunc("date-day",1,1,function(a){assert_date(a[0]);return a[0].getDate()});define_libfunc("date-month",1,1,function(a){assert_date(a[0]);return a[0].getMonth()+1});define_libfunc("date-year",1,1,function(a){assert_date(a[0]);return a[0].getFullYear()});define_libfunc("date-week-day",1,1,function(a){assert_date(a[0]);return a[0].getDay()});BiwaScheme.date_names={weekday:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],full_weekday:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],month:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],full_month:["January","February","March","April","May","June","July","August","September","Octorber","November","December"]};BiwaScheme.date2string=function(d,e){var f=function(g){return g<10?"0"+g:""+g};var c=function(g){return g<10?" "+g:""+g};var a={a:function(g){return date_names.weekday[g.getDay()]},A:function(g){return date_names.full_weekday[g.getDay()]},b:function(g){return date_names.month[g.getMonth()]},B:function(g){return date_names.full_month[g.getMonth()]},c:function(g){return g.toString()},d:function(g){return f(g.getDate())},D:function(g){return a.d(g)+a.m(g)+a.y(g)},e:function(g){return c(g.getDate())},f:function(g){return g.getSeconds()+g.getMilliseconds()/1000},h:function(g){return date_names.month[g.getMonth()]},H:function(g){return f(g.getHours())},I:function(g){var j=g.getHours();return f(j<13?j:j-12)},j:function(g){throw new Bug("not implemented: day of year")},k:function(g){return c(g.getHours())},l:function(g){var j=g.getHours();return c(j<13?j:j-12)},m:function(g){return f(g.getMonth())},M:function(g){return f(g.getMinutes())},n:function(g){return"\n"},N:function(g){throw new Bug("not implemented: nanoseconds")},p:function(g){return g.getHours()<13?"AM":"PM"},r:function(g){return a.I(g)+":"+a.M(g)+":"+a.S(g)+" "+a.p(g)},s:function(g){return Math.floor(g.getTime()/1000)},S:function(g){return f(g.getSeconds())},t:function(g){return"\t"},T:function(g){return a.H(g)+":"+a.M(g)+":"+a.S(g)},U:function(g){throw new Bug("not implemented: weeknum(0~, Sun)")},V:function(g){throw new Bug("not implemented: weeknum(1~, Sun?)")},w:function(g){return g.getDay()},W:function(g){throw new Bug("not implemented: weeknum(0~, Mon)")},x:function(g){throw new Bug("not implemented: weeknum(1~, Mon)")},X:function(g){return a.Y(g)+"/"+a.m(g)+"/"+a.d(g)},y:function(g){return g.getFullYear()%100},Y:function(g){return g.getFullYear()},z:function(g){throw new Bug("not implemented: time-zone")},Z:function(g){throw new Bug("not implemented: symbol time zone")},1:function(g){throw new Bug("not implemented: ISO-8601 year-month-day format")},2:function(g){throw new Bug("not implemented: ISO-8601 hour-minute-second-timezone format")},3:function(g){throw new Bug("not implemented: ISO-8601 hour-minute-second format")},4:function(g){throw new Bug("not implemented: ISO-8601 year-month-day-hour-minute-second-timezone format")},5:function(g){throw new Bug("not implemented: ISO-8601 year-month-day-hour-minute-second format")}};return e.replace(/~([\w1-5~])/g,function(j,g){var h=a[g];if(h){return h(d)}else{if(g=="~"){return"~"}else{return g}}})};define_libfunc("date->string",1,2,function(a){assert_date(a[0]);if(a[1]){assert_string(a[1]);return date2string(a[0],a[1])}else{return a[0].toString()}});define_libfunc("parse-date",1,1,function(a){assert_string(a[0]);return new Date(Date.parse(a[0]))});define_libfunc("random-integer",1,1,function(a){var c=a[0];assert_integer(c);if(c<0){throw new Error("random-integer: the argument must be >= 0")}else{return Math.floor(Math.random()*a[0])}});define_libfunc("random-real",0,0,function(a){return Math.random()});var user_write_ss=function(a){BiwaScheme.Port.current_output.put_string(write_ss(a[0]),true);return BiwaScheme.undef};define_libfunc("write/ss",1,2,user_write_ss);define_libfunc("write-with-shared-structure",1,2,user_write_ss);define_libfunc("write*",1,2,user_write_ss);define_libfunc("vector-append",2,null,function(a){var c=[];return c.concat.apply(c,a)});define_libfunc("vector-copy",1,1,function(a){assert_vector(a[0]);return _.clone(a[0])})};